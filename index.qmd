---
title: "Input per bilancio di missione"
date: last-modified
date-format: "DD-MMMM-YYYY"
lang: it

format:
  html:
    theme: flatly #spacelab
    # css: utils/style.css
    code-fold: true # redundant bc echo false 
    toc-depth: 3
    toc_float: true
    toc-location: left
    toc-title: Indice
    embed-resources: true # external dependencies embedded (Not in ..._files/)
  docx:
    toc: false
    toc-depth: 3
    toc-title: "Indice"
    highlight-style: tango #github
    embed-resources: true
    page-width: 9
    fig-width: 8  # per usare tutta la larghezza della pagina!!!
    fig-height: 6
    dpi: 300
execute:
  eval: true
  echo: false # x mostrare codice anche in file docx
  warning: false
  error: false
  output: false

#bibliography: ../../bib/CRP_dash.bib
#suppress-bibliography: false
---


```{r}
# Packgs and functions ----
library(here)
library(fs)
library(readxl)
library(janitor)
library(skimr)
library(glue)

library(dplyr)
library(tidyr)
library(forcats)
library(stringr)
library(purrr)
library(flextable)
library(sf)
library(ggplot2)
library(ggiraph)
library(camcorder)
library(patchwork) # for combining ggplots
# p1 + p2                    # Affiancati
# p1 / p2                    # Uno sopra l'altro
# p1 | p2                    # Affiancati (equivalente a +)
# (p1 + p2) / p3             # Layout complesso
# p1 + p2 + plot_layout(ncol = 2)  # Specificare colonne

# Colors ----
grey_extra_sc <- "#4F4F4F"
grey_sc <- "#808080"
grey_md1 <- "#A9A9A9"
grey_md2 <- "#D3D3D3"
grey_extrlight <- "#FDFBF7"
burg_sc <- "#5C2129"
burg_md <- "#873C4A"
burg_lg <- "#B85E6A"
blu_sc <- "#033c55"
blu_md <- "#005d82"
blu_lg <- "#5582a7"
grn_sc <- "#246864"
grn_md <- "#539d90"
grn_lg <- "#8eb9b1"
ylw_sc <- "#b27d2c"
ylw_md <- "#d9a44a"
ylw_lg <- "#f0c166"
```


```{r}
# ------- R utilities and functions  
#source(file = here("R","f_recap_values.R")) # # f_recap_values(df, c("col1","col2"))
source(file = here("R","f_ft_formatting.R")) # %>% f_ft_properties()

source(file = here("R","f_ggplot2.R")) # custom ggplot2 theme
```


# 1° PRIORITÀ: Ridurre le disuguaglianze 

> "La Fondazione si pone l'obiettivo strategico di affrontare dinamiche che influenzano le disparità e le distanze tra persone." [DPP 2025]"

Quali sono le **dinamiche demografiche in atto** che influenzano le disuguaglianze e le distanze tra persone?

## Popolazione residente

<!-- Dati provenienti da:
+ Istat, popolazione straniera (aggiornati al 01/01/2025), e da 
+ Regione Emilia-Romagna - Statistica, aggiornati al 03/06/2025.  
-->

```{r}
#| label: pop_prov_data

# Import dati ----
# Puliti in `data_in/RER_statistica/convert_RER_2tidy.R`
resident_prov_eta5_sex <- readRDS(here("data_in", "pop_resid_2025", "RER_statistica", "resident_prov_eta5_sex.rds")) |>
  rename(territorio = provincia) |> 
  mutate(genere =  factor(genere, levels = c("Maschi", "Femmine", "Totale")))

tabyl(resident_prov_eta5_sex$genere)
tabyl(resident_prov_eta5_sex$fascia_eta)

# popolazione residente Parma 2025
pop_parma_2025 <- resident_prov_eta5_sex |>
  dplyr::filter(territorio == "Parma" & genere == "Totale" & fascia_eta == "Tutte_eta") |>
  dplyr::pull(residenti)

# popolazione residente ER 2025
pop_ER_2025 <- resident_prov_eta5_sex |>
  dplyr::filter(territorio == "Emilia-Romagna" & genere == "Totale" & fascia_eta == "Tutte_eta") |>
dplyr::pull(residenti)
```


```{r}
#| label: resid_stran_parma

# Import dati stranieri ----
# Puliti in `data_in/istat_demo_stran_2025/convert_istat_pop_2tidy.R`
resid_stran_eta5_sex_PR <- readRDS("~/Github/bilancio_missione/data_in/pop_resid_2025/istat_demo_stran_2025/resid_stran_eta5_sex_PR.rds") |> 
  mutate(genere =  factor(genere, levels = c("Maschi", "Femmine", "Totale")))

tabyl(resid_stran_eta5_sex_PR$genere)
tabyl(resid_stran_eta5_sex_PR$fascia_eta)

# popolazione straniera residente Parma 2025
pop_stran_parma_2025 <- resid_stran_eta5_sex_PR |>
  dplyr::filter(territorio == "Parma" & genere == "Totale" ) |>
    # non c'è la fascia "Tutte_eta" perciò sommo tutte le età
  dplyr::summarise(
    totale_residenti_stranieri = sum(residenti)
  ) |> 
  dplyr::pull(totale_residenti_stranieri)
```

```{r}
#| label: resid_stran_ER

# Import dati stranieri ----
# Puliti in `data_in/istat_demo_stran_2025/convert_istat_pop_2tidy.R`
resid_stran_eta5_sex_ER <- readRDS("~/Github/bilancio_missione/data_in/pop_resid_2025/istat_demo_stran_2025/resid_stran_eta5_sex_ER.rds")

tabyl(resid_stran_eta5_sex_ER$genere)
tabyl(resid_stran_eta5_sex_ER$fascia_eta)

# popolazione straniera residente Parma 2025
pop_stran_ER_2025 <- resid_stran_eta5_sex_ER |>
  dplyr::filter(territorio == "Emilia-Romagna" & genere == "Totale" ) |>
  dplyr::summarise(
    totale_residenti_stranieri = sum(residenti)
  ) |> 
  dplyr::pull(totale_residenti_stranieri)
```


La popolazione residente nella provincia di Parma nel 2025 (ultimo aggiornamento: 03/06/2025) è di `r scales::label_number(big.mark = ".", decimal.mark = ",")(pop_parma_2025)` abitanti. Il territorio accoglie una percentuale di residenti stranieri più alta della media regionale, al cui interno, la distribuzione per età mostra una concentrazione in fasce più giovani.

### [Tbl] Popolazione residente (con % straniera)

```{r}
#| label: tbl_pop_parma_ER_2025
#| output: true

# Tabella popolazione residente Parma ed ER 2025 ( con distinzione straniera )----
tbl_pop_parma_ER_2025 <- tibble(
  Territorio = c("Parma", "Emilia-Romagna"),
  pop_residente_2025 = c(pop_parma_2025, pop_ER_2025),
  pop_stran_residente_2025 = c(pop_stran_parma_2025, pop_stran_ER_2025)) |>
  mutate(Perc_stranieri = round(pop_stran_residente_2025 /pop_residente_2025  * 100, 2)) |>
  flextable()  |>
  colformat_double(
    j = c("pop_residente_2025", "pop_stran_residente_2025"),
    big.mark = ".",
    decimal.mark = ",",
    digits = 0,
    na_str = "N.D.") |>
  # Formattazione percentuale
  colformat_double(
    j = "Perc_stranieri",
    big.mark = ".",
    decimal.mark = ",",
    digits = 2,
    suffix = " %",
    na_str = "N.D.") |>
  # Headers
  set_header_labels(
    Territorio = "Territorio",
    pop_residente_2025 = "Popolazione residente (2025)",
    pop_stran_residente_2025 = "Popolazione straniera residente (2025)",
    Perc_stranieri = "% popolazione straniera sul totale (2025)"
  ) |>
  add_header_lines(values = "Popolazione residente e straniera a Parma ed Emilia-Romagna (2025)", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Regione Emilia-Romagna - Statistica e Istat - Demografia in cifre, 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") |>
  # add background to italia and Parma
  bg(i = ~ Territorio %in% c("Parma"), bg = ylw_lg, part = "body") |>
  f_ft_word()

tbl_pop_parma_ER_2025
```


```{r}
# save as Rds
saveRDS(object =  tbl_pop_parma_ER_2025, file = here("data_out", "pop_resid_2025", "tbl_pop_parma_ER_2025.rds"))

# save as word docx
flextable::save_as_docx(tbl_pop_parma_ER_2025, path = here("data_out", "pop_resid_2025", "tbl_pop_parma_ER_2025.docx"))
```


### Piramide d'età
```{r}
#| label: plot_parma_piramid
#| output: false

# Data 
piramid_pop_PR_data <- resident_prov_eta5_sex |>
  # filter
  dplyr::filter(territorio == "Parma" & fascia_eta != "Tutte_eta" & genere %in% c("Maschi", "Femmine")) |> 
  dplyr::mutate(
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d)$", "0\\1-0\\2"),
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d{2})$", "0\\1-\\2")
  )

# ------- Save data  objects
# as RDS
saveRDS(object =  piramid_pop_PR_data, file = here("data_out", "pop_resid_2025","piramid_pop_PR_data.rds"))
# as XLSX
writexl::write_xlsx(x = piramid_pop_PR_data, path = here("data_out", "pop_resid_2025", "piramid_pop_PR_data.xlsx"))


# Plot piramide età Parma 2025 ----

# Calculate nice limit automatically
max_pop <- max(abs(piramid_pop_PR_data$residenti))
nice_limit <- ceiling(max_pop / 1000) * 1000  # Round up to nearest 1000

piramid_pop_PR <- piramid_pop_PR_data |>
  ggplot(aes(
    x = fascia_eta,
    y = residenti,
    fill = genere
  )) +
  geom_bar(
    data = \(df) df |> filter(genere == "Maschi"),
    aes(y = -residenti),
    stat = "identity"
  ) +
  geom_bar(
    data = \(df) df |> filter(genere == "Femmine"),
    aes(y = residenti),
    stat = "identity"
  ) +
  coord_flip() +
  scale_y_continuous(
    labels = \(x) scales::label_number(big.mark = ".", decimal.mark = ",")(abs(x)),
    breaks = seq(-nice_limit, nice_limit, by = nice_limit/4),
    limits = c(-nice_limit, nice_limit),
    expand = expansion(mult = 0.025)
  ) +
  scale_fill_manual(
    values = c("Maschi" = blu_lg, "Femmine" = burg_lg)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = rel(0.85), angle= 45),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    plot.subtitle = element_text(size = rel(0.95), lineheight = 1.2, margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    # title = "Popolazione residente a Parma (2025)",
    # subtitle = "Valori assoluti per sesso fasce d'età quinquennali",
    # caption = "Fonte: Regione Emilia-Romagna - Statistica",
    x = "",
    y = "",
    fill = "Sesso"
  )

# Stampa il grafico e salva manualmente
piramid_pop_PR
```

```{r}
#| label: plot_parma_str_piramid
#| output: false

# Plot piramide età stranieri Parma 2025 ----

piramid_pop_stran_PR_data <- resid_stran_eta5_sex_PR |>
  dplyr::filter(territorio == "Parma" & genere %in% c("Maschi", "Femmine")) |>
  dplyr::mutate(
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d)$", "0\\1-0\\2"),
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d{2})$", "0\\1-\\2")
  )

# ------- Save data and plot objects
# as RDS
saveRDS(object =  piramid_pop_stran_PR_data, file = here("data_out", "pop_resid_2025","piramid_pop_stran_PR_data.rds"))
# as XLSX
writexl::write_xlsx(x = piramid_pop_stran_PR_data, path = here("data_out", "pop_resid_2025", "piramid_pop_stran_PR_data.xlsx"))


# Calculate nice limit automatically
max_stran <- max(abs(piramid_pop_stran_PR_data$residenti))
nice_limit_stran <- ceiling(max_stran / 100) * 100  # Round up to nearest 100

piramid_pop_stran_PR <- piramid_pop_stran_PR_data  |>
  ggplot(aes(
    x = fascia_eta,
    y = residenti,
    fill = genere
  )) +
  geom_bar(
    data = \(df) df |> filter(genere == "Maschi"),
    aes(y = -residenti),
    stat = "identity"
  ) +
  geom_bar(
    data = \(df) df |> filter(genere == "Femmine"),
    aes(y = residenti),
    stat = "identity"
  ) +
  coord_flip() +
  scale_y_continuous(
    labels = \(x) scales::label_number(big.mark = ".", decimal.mark = ",")(abs(x)),
    breaks = seq(-nice_limit_stran, nice_limit_stran, by = nice_limit_stran/4),
    limits = c(-nice_limit_stran, nice_limit_stran),
    expand = expansion(mult = 0.025)
  ) +
  scale_fill_manual(
    values = c("Maschi" = blu_lg, "Femmine" = burg_lg)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = rel(0.85), angle= 45),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    plot.subtitle = element_text(size = rel(0.95), lineheight = 1.2, margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    # title = "Popolazione STRANIERA residente a Parma (2025)",
    # subtitle = "Valori assoluti per sesso fasce d'età quinquennali",
    # caption = "Fonte: IStat, Demografia in cifre",
    x = "",
    y = "",
    fill = "Sesso"
  )


# Stampa il grafico e salva manualmente
piramid_pop_stran_PR

```

```{r}
#| output: true

library(patchwork)
# Combine plots
piramids_PR_both <- piramid_pop_PR + piramid_pop_stran_PR +
  plot_layout(guides = "collect") +  # This collects and merges legends
  plot_annotation(
    title = "Piramidi d'età della popolazione residente a Parma (2025)",
    subtitle = "Confronto tra popolazione totale e straniera (scale diverse)",
    caption = "Fonte: Regione Emilia-Romagna - Statistica e Istat - Demografia in cifre") &
  theme(
    plot.title = element_text(size = rel(1.4), face = "bold"),
    plot.subtitle = element_text(size = rel(1.1)),
    plot.caption = element_text(size = rel(0.9), face = "italic", color = grey_sc),
    legend.position = "bottom")

piramids_PR_both

# Save combined plot (manually)
 
```

## Popolazione per 4 distretti

La popolazione residente nella provincia di Parma è suddivisa in 4 distretti sanitari, e si concentra principalmente nel distretto di Parma città, che include il capoluogo e i comuni limitrofi. Nei distretti _Sud Est_ e _Valli Taro e Ceno_, che sono i meno popolati, si rileva anche la maggiore fragilità sociale ed economica, oltre che demografica -- Cfr. **RE-R Statistica**, 2025, [_"La potenziale fragilità demografica, sociale ed economica nei comuni della regione Emilia Romagna. Anno 2023"_](https://statistica.regione.emilia-romagna.it/studi-analisi/pubblicazioni-ricerche/rapporto-mappe-potenziale-fragilita-emilia-romagna-2023). 

```{r}
#| label: map_distretti_prep

# 1) Importa tabella link distretti-comuni
comuni_distretti_parma <- read_excel(here("data_in", "ER_shp", "comuni_distretti_parma.xlsx"))

# 2) Import comuni PARMA shapefile (istat, 2025) - Parma ----
ER_PR_comuni_sf <- readRDS(here("data_in", "ER_shp", "ER_PR_comuni_sf.rds")) |> 
  select(PRO_COM_T, COMUNE, Shape_Leng, Shape_Area, geometry)

# 3) Associa distretto a ogni comune di  Parma ----
ER_PR_comuni_distr_sf <- ER_PR_comuni_sf |>
  left_join(comuni_distretti_parma, by = c("COMUNE" = "Comune")) |>
  select(PRO_COM_T, COMUNE, Distretto, Shape_Leng, Shape_Area, geometry)

skim(ER_PR_comuni_distr_sf)
str(ER_PR_comuni_distr_sf)
unique(ER_PR_comuni_distr_sf$Distretto)

# 4) Make sf union per distretto ----
ER_PR_distretti_sf <- ER_PR_comuni_distr_sf %>%
    group_by(Distretto) %>%
    summarise(
      n_comuni = n(),
      comuni = paste(COMUNE, collapse = ", "),
      geometry = st_union(geometry),
      .groups = "drop"
    ) 

```


```{r}
#| label: resid_distretti_parma_data

# 1) Import dati pop residente x sesso/eta in distretti ER ----
resident_distr_eta_sex <- readRDS(here("data_in", "pop_resid_2025", "RER_statistica", "resident_distr_eta_sex.rds")) |> 
  # Separa una colonna con la provincia 
  dplyr::rename(distretto_prov = provincia) |> 
  dplyr::mutate(
    distretto = str_remove(distretto_prov, "\\s*\\(AUSL.*\\)$") |> str_trim(),
    ausl = str_extract(distretto_prov, "(?<=\\().*(?=\\))"),
    prov = str_extract(distretto_prov, "(?<=AUSL\\s)[A-Z]+")) |> 
  dplyr::mutate (
    provincia = case_when(
      prov == "PR" ~ "Parma",
      prov == "RE" ~ "Reggio nell'Emilia",
      prov == "MO" ~ "Modena",
      prov == "PC" ~ "Piacenza",
      prov == "BO" ~ "Bologna",
      prov == "I" ~ "Bologna",
      prov == "FE" ~ "Ferrara",
      prov == "R" & str_detect(distretto_prov, "Forlì") ~ "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Cesena")~  "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Rubicone")~  "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Rimini")~  "Rimini",
      prov == "R" & str_detect(distretto_prov, "Riccione")~  "Rimini",
      
      prov == "R" & str_detect(distretto_prov, "Ravenna")~  "Ravenna",
      prov == "R" & str_detect(distretto_prov, "Faenza")~  "Ravenna",
      prov == "R" & str_detect(distretto_prov, "Lugo")~  "Ravenna",
      TRUE ~ NA_character_)) |>  
  # filtra dati popolazione per distretti Parma ----
  dplyr::filter(prov == "PR")

names(resident_distr_eta_sex)
names(ER_PR_distretti_sf)
tabyl(resident_distr_eta_sex$fascia_eta)
tabyl(resident_distr_eta_sex$distretto)
tabyl(resident_distr_eta_sex$distretto_prov)

# Aggiungi geometria manualmente ----
resident_distr_eta_sex_sf <- resident_distr_eta_sex |>
  left_join(
    ER_PR_distretti_sf |> st_drop_geometry(),
    by = c("distretto_prov" = "Distretto")) |>
  left_join(
    ER_PR_distretti_sf |> select(Distretto, geometry),
    by = c("distretto_prov" = "Distretto")) |>
  st_as_sf()

# # 2) Split into separate datasets per sesso / eta ----
# distr_eta_tutti <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "Tutte_eta" & genere == "Totale") 
# 
# distr_eta_0_13 <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "0-13" & genere == "Totale")
# 
# distr_eta_14_59 <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "14-59" & genere == "Totale")
# 
# distr_eta_60_plus <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "60  e oltre" & genere == "Totale")
# 
# # 3) Associa geometria distretti a dati popolazione per distretti Parma ----
# distr_eta_tutti_sf <- ER_PR_distretti_sf |>
#   full_join(
#     distr_eta_tutti,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# distr_eta_0_13_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_0_13,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# 
# distr_eta_14_59_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_14_59,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# distr_eta_60_plus_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_60_plus,
#     by = c("Distretto" = "distretto_prov")
#   )

# SAve joined data 
saveRDS(object =  resident_distr_eta_sex_sf, file = here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf.rds"))

writexl::write_xlsx(x = resident_distr_eta_sex_sf, path = here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf.xlsx"))

sf::write_sf( resident_distr_eta_sex_sf,  here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf_shp",  "resident_distr_eta_sex_sf.shp"))
```


### [Tbl] Popolazione residente per distretti di Parma

```{r}
#| label: tbl_pop_distr_2025
#| output: true

# Tabella popolazione residente Parma ed ER 2025 ( con distinzione straniera )----
tbl_pop_distr_2025 <- resident_distr_eta_sex |>
  dplyr::filter(fascia_eta == "Tutte_eta" & genere == "Totale") |> 
  select(provincia, distretto_prov, residenti) |> 
  flextable()  |>
  # Headers
  set_header_labels( 
    provincia = "Provincia",
    distretto_prov = "Distretto",
    residenti = "Popolazione residente"
  ) |>
  add_header_lines(values = "Popolazione residente per distretto sanitario (2025)", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Regione Emilia-Romagna - Statistica, 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") 
 

tbl_pop_distr_2025

# save as Rds
saveRDS(object =  tbl_pop_distr_2025, file = here("data_out", "pop_resid_2025", "tbl_pop_distr_2025.rds"))
# save as word docx
flextable::save_as_docx(tbl_pop_distr_2025, path = here("data_out", "pop_resid_2025", "tbl_pop_distr_2025.docx"))
```


```{r}
#| label: map_distretti_parma_pop
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"


# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "Tutte_eta") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = distretto), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis",
    direction = -1,
    na.value = "grey90",
    name = "N. residenti",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = "") +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop
```


```{r}
#| label: map_distretti_parma_pop_anz
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"


# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_anz <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "60  e oltre") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
    geom_sf_label(aes(label = distretto), size = 3, alpha = 0.7) +  # Etichette con sfondo
scale_fill_viridis_c(
    option = "rocket",
    direction = -1,
    na.value = "grey90",
    name = "N. residenti 60+",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (60 anni e oltre)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_anz
```

```{r}
#| label: map_distretti_parma_pop_gio
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"


# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_gio <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "0-13") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
    geom_sf_label(aes(label = distretto), size = 3, alpha = 0.7) +  # Etichette con sfondo
scale_fill_viridis_c(
    option = "viridis",
    direction = -1,
    na.value = "grey90",
    name = "N. residenti < 14",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (0-13 anni)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_gio
```


## Trend demografici a confronto
<!-- ## Dati di input (ISTAT trend dem) -->
```{r}
# Directories ----
dir_data_in <- here::here("data_in", "istat_demo_2002_2024")
dir_data_out <- here::here("data_out","istat_demo_2002_2024")
```

```{r}
# --- Load dataset TREND DEMOGRAFICI ----
indicatori_di_struttura <- readRDS(fs::path(dir_data_in,  "indicatori_di_struttura.rds"))

speranza_di_vita_65 <- readRDS(fs::path(dir_data_in, "speranza_di_vita_65.rds"))

crescita_naturale <- readRDS(fs::path(dir_data_in, "crescita_naturale.rds"))

saldo_migratorio <- readRDS(fs::path(dir_data_in, "saldo_migratorio_totale.rds"))

# Esplora indicatori disponibili
# tabyl(indicatori_di_struttura$indicatore)
```

### Età media

Aumento della popolazione anziana e longevità

```{r}
#| label: e_m_data

# ------- Arguments for plot
INDICATORE <- "Età media"
UDM <- "anni e decimi di anno"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
e_m_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)

# ------- Save data and plot objects
# as RDS
saveRDS(object =  e_m_data, file = here(dir_data_out, "e_m_data.rds"))
# as XLSX
writexl::write_xlsx(x = e_m_data, path = here(dir_data_out, "e_m_data.xlsx"))
# as PNG (manuale)
```


```{r}
#| label: e_m_plot
#| output: true
 
# Plot: e_m_plot [= Età Media]  ----
e_m_plot <- e_m_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(e_m_data$anno), max(e_m_data$anno), by = 1),
    limits = c(min(e_m_data$anno), max(e_m_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
e_m_plot
```

### Indice di vecchiaia

```{r}
#| label: i_v_data

# ------- Arguments for plot
INDICATORE <- "Indice di vecchiaia"
UDM <- "% tra popolazione di 65+ anni e in età 0-14"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_v_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_v_data, file = here(dir_data_out, "i_v_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_v_data, path = here(dir_data_out, "i_v_data.xlsx"))
```

```{r}
#| label: i_v_plot
#| output: true
 
# Plot: i_v_plot [= Età Media]  ----
i_v_plot <- i_v_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_v_data$anno), max(i_v_data$anno), by = 1),
    limits = c(min(i_v_data$anno), max(i_v_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_v_plot
```

### Indice di dipendenza anziani

```{r}
#| label: i_d_a_data

# ------- Arguments for plot
INDICATORE <- "Indice di dipendenza anziani"
UDM <- "% tra popolazione di 65+ e in età attiva (15-64 anni)"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_d_a_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_d_a_data, file = here(dir_data_out, "i_d_a_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_d_a_data, path = here(dir_data_out, "i_d_a_data.xlsx"))
```

```{r}
#| label: i_d_a_plot
#| output: true
 
# Plot: i_d_a_plot [= Età Media]  ----
i_d_a_plot <- i_d_a_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_d_a_data$anno), max(i_d_a_data$anno), by = 1),
    limits = c(min(i_d_a_data$anno), max(i_d_a_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_d_a_plot
```


### Indice di dipendenza strutturale

```{r}
#| label: i_d_s_data

# ------- Arguments for plot
INDICATORE <- "Indice di dipendenza strutturale"
UDM <- "% tra popolazione in età non attiva (0-14 e 65+ anni) e in età attiva (15-64 anni)"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_d_s_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_d_s_data, file = here(dir_data_out, "i_d_s_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_d_s_data, path = here(dir_data_out, "i_d_s_data.xlsx"))
```

```{r}
#| label: i_d_s_plot
#| output: true
 
# Plot: i_d_s_plot [= Età Media]  ----
i_d_s_plot <- i_d_s_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_d_s_data$anno), max(i_d_s_data$anno), by = 1),
    limits = c(min(i_d_s_data$anno), max(i_d_s_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_d_s_plot
```

### Crescita naturale della popolazione

```{r}
#| label: c_n_data

c_n_data <- crescita_naturale |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "ITALIA")) |>
  dplyr::mutate(
    territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "ITALIA"))
  )

```

```{r}
#| label: c_n_plot
#| output: true

c_n_plot <- c_n_data |>
  dplyr::filter(indicatore == "crescita_naturale") |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio,
    group = territorio
  )) +
  geom_line(linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(c_n_data$anno), max(c_n_data$anno), by = 1),
    limits = c(min(c_n_data$anno), max(c_n_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(
      size = rel(1.3),
      face = "bold",
      margin = margin(b = 10)
    ),
    plot.subtitle = element_text(
      size = rel(0.95),
      lineheight = 1.2,
      margin = margin(b = 10)
    ),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Trend demografici: crescita naturale",
    subtitle = "Indicatore espresso in: differenza tra il tasso di natalità e il tasso di mortalità",
    caption = CAP,
    x = "",
    y = ""
  )

c_n_plot
```

```{r}
#| label: c_n_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  c_n_data, file = here(dir_data_out, "c_n_data.rds"))
# as XLSX
writexl::write_xlsx(x = c_n_data, path = here(dir_data_out, "c_n_data.xlsx"))

```


### Saldo migratorio

```{r}
#| label: s_m_data

# ------- Read input data
s_m_data <- saldo_migratorio |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  )  

# ------- Save data and plot objects
# as RDS
saveRDS(object =  s_m_data, file = here(dir_data_out, "s_m_data.rds"))
# as XLSX
writexl::write_xlsx(x = s_m_data, path = here(dir_data_out, "s_m_data.xlsx"))
```

```{r}
#| label: s_m_plot
#| output: true
 
# Plot: i_d_s_plot [= Età Media]  ----
s_m_plot <- s_m_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio,
    group = territorio)) +
  geom_line(linewidth = rel(1.2) ) +
  scale_x_continuous(
    breaks = seq(min(s_m_data$anno), max(s_m_data$anno), by = 1),
    limits = c(min(s_m_data$anno), max(s_m_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(
      size = rel(1.3),
      face = "bold",
      margin = margin(b = 10) ),
    plot.subtitle = element_text(
      size = rel(0.95),
      lineheight = 1.2,
      margin = margin(b = 10)  ),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")  ) +
  labs(
    title = "Trend demografici: saldo migratorio totale",
    subtitle = "Indicatore espresso in: differenza tra num. iscritti ed num. cancellati dai registri anagrafici per trasferimento di residenza",
    caption = CAP,
    x = "",
    y = "")
# Stampa il grafico (questo triggera il salvataggio)
s_m_plot
```



<!-- ### Migrazione e diversità culturale -->

\newpage

# ____

# 2° PRIORITÀ: Rafforzare istituzioni e persone 

> "La Fondazione si pone l'obiettivo strategico di lavorare per il rafforzamento di entrambe i livelli, persone e istituzioni"come crescita, formazione innovazione, e come messa in rete del proprio contributo. [DPP 2025]"


<!-- ## Dati di input (ISTAT BES)
I dati di seguito vengono da [IstatData - BES (Benessere Equo e Sostenibile)](https://esploradati.istat.it/databrowser/#/it/dw/categories/IT1,Z0930TER,1.0/BES_T/IT1,DF_BES_TERRIT_0T,1.0), che, a sua volta, attinge a varie fonti Istat e non-Istat. -->

```{r}
# Directories ----
dir_data_in2 <- here::here("data_in", "bes_2003_2023")
dir_data_out2 <- here::here("data_out","bes_2003_2023")
```



```{r}
# --- Load dataset TREND DEMOGRAFICI ----
amb_df <- readRDS(fs::path(dir_data_in2,  "amb_df.rds"))
ben_econ_df <- readRDS(fs::path(dir_data_in2, "ben_econ_df.rds"))
ist_formaz_df <- readRDS(fs::path(dir_data_in2, "ist_formaz_df.rds"))
lav_df <- readRDS(fs::path(dir_data_in2, "lav_df.rds"))
patr_cult_df <- readRDS(fs::path(dir_data_in2, "patr_cult_df.rds"))
qual_serv_df <- readRDS(fs::path(dir_data_in2, "qual_serv_df.rds"))
rel_pol_df <- readRDS(fs::path(dir_data_in2, "rel_pol_df.rds"))
ric_innov_df <- readRDS(fs::path(dir_data_in2, "ric_innov_df.rds"))
sal_df <- readRDS(fs::path(dir_data_in2, "sal_df.rds"))
sic_df <- readRDS(fs::path(dir_data_in2, "sic_df.rds"))

# Esplora indicatori disponibili
# tabyl(indicatori_di_struttura$indicatore)
```

### [Tbl] Reddito medio disponibile pro capite

Qs tabella è copiata a mano da [IstatData](https://esploradati.istat.it/databrowser/#/it/dw/categories/IT1,Z0930TER,1.0/BES_T/IT1,DF_BES_TERRIT_0T,1.0)

**Reddito medio disponibile pro capite (€)** = si tratta di un _aggregato di contabilità nazionale_ che rappresenta il reddito medio annuo di cui una persona può disporre, al netto di imposte e contributi, tenendo conto anche di pensioni e trasferimenti pubblici.

+ NB: anche se viene chiamato "Reddito disponibile _lordo_ pro capite" nei documenti Istat, in realta' è già al netto delle imposte e dei contributi sociali obbligatori, quindi non è lordo in senso fiscale comune, ma nel senso della contabilita' nazionale.

+ In termini comparativi internazionali, il reddito disponibile pro capite è espresso in unità di potere d'acquisto (Purchasing Power Standard - PPS), che consente di eliminare le differenze di prezzo tra i paesi e di confrontare il potere d'acquisto effettivo dei redditi delle famiglie.

+ (+/- comparabile con) **Adjusted gross disposable income of households per capita in PPS** - [Eurostat](https://ec.europa.eu/eurostat/databrowser/view/tec00113/default/table?lang=en)

```{r}
#| label: redd_table
#| output: true

reddito <- tibble(
  territorio = c(
    "Italia",
    "Nord-ovest",
    "Nord-est",
    "Emilia-Romagna",
    "Parma",
    "Centro",
    "Sud",
    "Isole"),
  `2021` = c(20032, 23438, 22546, NA, 24381, 20897, 15280, 15517),
  `2022` = c(21297, 24910, 23985, 24898, NA, 22223, 16213, 16527),
  `2023` = c(22359, 26265, 25172, 26073, 27083, 23113, 16999, 17439)) |> 
  flextable() |>
  colformat_double(
    j = c("2021", "2022", "2023"),
    big.mark = ".",
    decimal.mark = ",",
    digits = 0,
    na_str = "N.D.") |>
  add_header_lines(values = "Reddito medio disponibile pro capite (€), 2021-2023", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") |>
  # add background to italia and Parma
  bg(i = ~ territorio %in% c("Italia"), bg = blu_lg, part = "body") |>
  bg(i = ~ territorio %in% c("Parma"), bg = burg_lg, part = "body") |>
  f_ft_word()

reddito
```

```{r}
# save as Rds
saveRDS(object =  reddito, file = here(dir_data_out2, "reddito.rds"))

# save as word docx
flextable::save_as_docx(reddito, path = here(dir_data_out2, "reddito.docx"))
```

### Retrib e pensioni medie
```{r}
#| label: retrib_data

tabyl(ben_econ_df$indicatore)

retrib <- ben_econ_df |>
  dplyr::filter(indicatore %in% c("Retribuzione media annua dei lavoratori dipendenti", "Importo medio annuo pro-capite dei redditi pensionistici")) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))
```

```{r}
#| label: retrib_plot
#| output: true
#| fig-cap: "Andamento del Reddito medio disponibile pro capite e Retribuzione media annua dei lavoratori dipendenti  in Emilia-Romagna, Italia e Parma (2004-2023)"

# Plot: faceted histogram ----
retrib_plot <- retrib  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  #geom_col(position = "dodge", width = 0.8) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "grey",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
    facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Benessere economico: reddito (da lavoro e pensionistico)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

retrib_plot
```

```{r}
#| label: retrib_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  retrib, file = here(dir_data_out2, "retrib.rds"))
# as xlsx
writexl::write_xlsx(x = retrib, path = here(dir_data_out2, "retrib.xlsx"))
```

### Occupazione
```{r}
#| label: occup_data

lav_df

tabyl(lav_df$indicatore)

occup <- lav_df |>
  dplyr::filter(indicatore%in% c("Tasso di occupazione (20-64 anni)",
                                 "Tasso di occupazione giovanile (15-29 anni)"#
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia"))) #|> 
  # rewrite indicator names
  # dplyr::mutate(
  #   indicatore = dplyr::case_when(
  #     indicatore == "Tasso di occupazione" ~ "% di disoccupati e inattivi 'disponibili' (15-74 anni)",
  #     indicatore == "Tasso di mancata partecipazione al lavoro giovanile (15-29 anni)" ~ "% di disoccupati + inattivi 'disponibili' (15-29 anni)",
  #     TRUE ~ indicatore ) )

```


```{r}
#| label: occup_plot
#| output: true

# Plot: faceted histogram ----
occup_plot <- occup  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  #geom_col(position = "dodge", width = 0.8) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "grey",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
    facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Mancata partecipazione al lavoro",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

occup_plot
```

```{r}
#| label: occup_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  occup, file = here(dir_data_out2, "occup.rds"))
# as xlsx
writexl::write_xlsx(x = occup, path = here(dir_data_out2, "occup.xlsx"))
```

### Disoccupazione e mancata partecipazione al lavoro

Il **tasso di mancata partecipazione al lavoro** misura il _Rapporto tra la somma di disoccupati e inattivi "disponibili" (persone che non hanno cercato lavoro nelle ultime 4 settimane ma sono disponibili a lavorare), e la somma di forze lavoro (insieme di occupati e disoccupati) e inattivi "disponibili", riferito alla popolazione tra 15 e 74 anni._

sono né occupate né in cerca di occupazione (inattivi). Un tasso elevato indica una maggiore difficoltà nel coinvolgimento della popolazione nel mercato del lavoro, il che può essere associato a problemi economici e sociali.
```{r}
#| label: disoccup_data

lav_df

tabyl(lav_df$indicatore)

disocc <- lav_df |>
  dplyr::filter(indicatore%in% c("Tasso di mancata partecipazione al lavoro",
                                 "Tasso di mancata partecipazione al lavoro giovanile (15-29 anni)"#
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia"))) |> 
  # rewrite indicator names
  dplyr::mutate(
    indicatore = dplyr::case_when(
      indicatore == "Tasso di mancata partecipazione al lavoro" ~ "% di disoccupati e inattivi 'disponibili' (15-74 anni)",
      indicatore == "Tasso di mancata partecipazione al lavoro giovanile (15-29 anni)" ~ "% di disoccupati e inattivi 'disponibili' (15-29 anni)",
      TRUE ~ indicatore
    )
  )

```


```{r}
#| label: disoccup_plot
#| output: true

# Plot: faceted histogram ----
disocc_plot <- disocc  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  #geom_col(position = "dodge", width = 0.8) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "grey",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
    facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Mancata partecipazione al lavoro",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

disocc_plot
```

```{r}
#| label: disoccup_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  disocc, file = here(dir_data_out2, "disocc.rds"))
# as xlsx
writexl::write_xlsx(x = disocc, path = here(dir_data_out2, "disocc.xlsx"))
```

### NEET 

[Dati un po' incompleti, sarebbe bello approfondire da fonte primaria: _Rilevazione sulle Forze di lavoro_]
```{r}
#| label: neet_data

neet <- ist_formaz_df |>
  dplyr::filter(indicatore%in% c("Giovani che non lavorano e non studiano (NEET)"#,
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |> 
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Nord-est" )))    |>
  dplyr::filter(anno > 2018)
```

```{r}
#| label: neet_plot
#| output: true

# Plot: histogram ----
neet_plot <- neet  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "white",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg,
      "Nord-est" = grey_md1)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Giovani che non lavorano e non studiano (NEET)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "% di persone tra 15-29 anni")

neet_plot
```


```{r}
#| label: neet_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  neet, file = here(dir_data_out2, "neet.rds"))
# as xlsx
writexl::write_xlsx(x = neet, path = here(dir_data_out2, "neet.xlsx"))
```

### Formazione continua 

[Dati un po' incompleti, sarebbe bello approfondire da fonte primaria: _Rilevazione sulle Forze di lavoro_]

```{r}
#| label: formaz_data

formaz <- ist_formaz_df |>
  dplyr::filter(indicatore%in% c("Partecipazione alla formazione continua"#,
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |> 
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna" , "Italia")) |>
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia")))    |>
  dplyr::filter(anno > 2018)
```

```{r}
#| label: formaz_plot
#| output: true

# Plot: histogram ----
formaz_plot <- formaz  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "white",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg,
      "Nord-est" = grey_md1)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(1)),
    axis.text.y = element_text(size = rel(1)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Persone che hanno partecipato ad attività di istruzione e formazione nelle 4 settimane precedenti l'intervista",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "% di persone tra 25-64 anni")

formaz_plot
```

```{r}
#| label: formaz_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  formaz, file = here(dir_data_out2, "formaz.rds"))
# as xlsx
writexl::write_xlsx(x = formaz, path = here(dir_data_out2, "formaz.xlsx"))
```

### Mobilità dei laureati

**Mobilità dei laureati italiani (25-39 anni)** = Tasso di migratorietà specifico dei laureati italiani di 25-39 anni (differenza tra iscritti e cancellati per trasferimento di residenza/popolazione residente *1000).Sia il numeratore che il denominatore si riferiscono ai cittadini italiani di 25-39 anni con titolo di studio terziario (laurea, AFAM, dottorato). I valori per l'Italia comprendono solo i movimenti da/per l'estero, poiché il saldo migratorio interno a livello nazionale è pari a zero; la disaggregazione territoriale comprende anche i movimenti interni.

```{r}
#| label: mob_lau_data

mob_lau <- ric_innov_df |>
  dplyr::filter(indicatore%in% c("Mobilità dei laureati italiani (25-39 anni)")) |> 
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna" , "Italia")) |>
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia"))) 
```

```{r}
#| label: mob_lau_plot
#| output: true

# Plot: histogram ----
mob_lau_plot <- mob_lau  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "white",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg,
      "Nord-est" = grey_md1)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10),
    expand= expansion(mult = c(0.25,0.25))
    ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(1)),
    axis.text.y = element_text(size = rel(1)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Mobilità (differenza tra iscritti e cancellati) per trasferimento \ndi residenza dei laureati italiani (25-39 anni)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "Saldo su popolazione residente X 1000")

mob_lau_plot
```

```{r}
#| label: mob_lau_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  mob_lau, file = here(dir_data_out2, "mob_lau.rds"))
# as xlsx
writexl::write_xlsx(x = mob_lau, path = here(dir_data_out2, "mob_lau.xlsx"))
```

<!-- ### Salute  -->

<!-- Qs somo un po' ridondanti rispetto ai trend demografici -->
<!-- ```{r} -->
<!-- #| label: salute_data -->

<!-- sal_df -->
<!-- tabyl(sal_df$indicatore) -->
<!-- ``` -->

# ____

# 3° PRIORITÀ: Accompagnare le trasformazioni del territorio

> "La Fondazione si pone l'obiettivo strategico di accompagnare il territorio di parma lungo le trasformazioni e i cambiamenti inevitabili", supportando una nuova visione strategiica e valorizzando sinergia tra obiettivi. [DPP 2025]"

### Servizi sanitari
```{r}
#| label: servizi_san_data

servizi_san <- qual_serv_df |>
  dplyr::filter(indicatore%in% c("Emigrazione ospedaliera in altra regione",
                                 "Medici specialisti",
                                 "Posti letto per specialità ad elevata assistenza")) |>
  # establish order of indicators
  dplyr::mutate(indicatore = factor(indicatore, levels = c(
    "Medici specialisti",
    "Posti letto per specialità ad elevata assistenza",
    "Emigrazione ospedaliera in altra regione"))) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))
```

```{r}
#| label: servizi_san_plot
#| output: true

# Plot: faceted histogram ----
servizi_san_plot <- servizi_san  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  #geom_col(position = "dodge", width = 0.8) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "grey",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
    facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Servizi sanitari (valori per 10.000 abitanti)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

servizi_san_plot
```

```{r}
#| label: servizi_san_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  servizi_san, file = here(dir_data_out2, "servizi_san.rds"))
# as xlsx
writexl::write_xlsx(x = servizi_san, path = here(dir_data_out2, "servizi_san.xlsx"))
```


### Servizi (internet)

Più librerie, più musei, più strutture, più verde urbano ecc

```{r}
#| label: servizi_data

qual_serv_df
tabyl(qual_serv_df$indicatore)


internet <- qual_serv_df |>
  dplyr::filter(indicatore%in% c("Copertura della rete fissa di accesso ultra veloce a internet"#
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))

tabyl(internet$territorio)
```

```{r}
#| label: internet_plot
#| output: true

# Plot: lines with dots ----
internet_plot <- internet  |>
  ggplot(aes(x = anno, y = valore, color = territorio, group = territorio)) +
  geom_line(linewidth = rel(1.2)) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "Italia" = blu_md
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Copertura della rete fissa di accesso ultra veloce a internet",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "% di famiglie residenti in zone servite"
  )

internet_plot
```

```{r}
#| label: internet_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  internet, file = here(dir_data_out2, "internet.rds"))
# as xlsx
writexl::write_xlsx(x = internet, path = here(dir_data_out2, "internet.xlsx"))
```

### Servizi (raccolta differenziata)

```{r}
#| label: raccolta_diff_data

raccolta_diff <- qual_serv_df |>
  dplyr::filter(indicatore%in% c("Servizio di raccolta differenziata dei rifiuti urbani"#
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))
```

```{r}
#| label: raccolta_diff_plot
#| output: true

# Plot: lines with dots ----
raccolta_diff_plot <- raccolta_diff  |>
ggplot(aes(x = anno, y = valore, color = territorio, group = territorio)) +
  geom_line(linewidth = rel(1.2)) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "Italia" = blu_md
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Servizio di raccolta differenziata dei rifiuti urbani",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "% di popolazione residenti in comuni serviti"
  )

raccolta_diff_plot
```

```{r}
#| label: raccolta_diff_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  raccolta_diff, file = here(dir_data_out2, "raccolta_diff.rds"))
# as xlsx
writexl::write_xlsx(x = raccolta_diff, path = here(dir_data_out2, "raccolta_diff.xlsx"))
```

### Servizi (irreg elettricita')

```{r}
#| label: irreg_ele_data

irreg_ele <- qual_serv_df |>
  dplyr::filter(indicatore%in% c("Irregolarità del servizio elettrico"#
                                 #"Tasso di occupazione giovanile (15-29 anni)"
  )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))
```

```{r}
#| label: irreg_ele_plot
#| output: true

# Plot: lines with dots ----
irreg_ele_plot <- irreg_ele  |>
ggplot(aes(x = anno, y = valore, color = territorio, group = territorio)) +
  geom_line(linewidth = rel(1.2)) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "Italia" = blu_md
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Irregolarità del servizio elettrico",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "N. medio per utente delle interruzioni accidentali lunghe"
  )

irreg_ele_plot
```

```{r}
#| label: irreg_ele_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  irreg_ele, file = here(dir_data_out2, "irreg_ele.rds"))
# as xlsx
writexl::write_xlsx(x = irreg_ele, path = here(dir_data_out2, "irreg_ele.xlsx"))

```

<!-- ### Sicurezza -->
<!-- ```{r} -->
<!-- #| label: sicurezza_data -->

<!-- sic_df -->

<!-- ``` -->

### Verde urbano
```{r}
amb_df
tabyl(amb_df$indicatore)
# Dispersione da rete idrica comunale
# Disponibilità di verde urbano
```


```{r}
#| label: verde_data
verde <- amb_df |>
  dplyr::filter(indicatore%in% c( "Disponibilità di verde urbano" )) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")))
```

```{r}
#| label: verde_plot
#| output: true

# Plot: lines with dots ----
verde_plot <- verde  |>
ggplot(aes(x = anno, y = valore, color = territorio, group = territorio)) +
  geom_line(linewidth = rel(1.2)) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "Parma" = burg_md,
      "Emilia-Romagna" = grn_md,
      "Italia" = blu_md
    )
  ) +
  scale_x_continuous( 
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Disponibilità di verde urbano nei comuni capoluogo di provincia/città metropolitana",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "mq di verde urbano per abitante"
  )
verde_plot
```

```{r}
#| label: verde_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  verde, file = here(dir_data_out2, "verde.rds"))
# as xlsx
writexl::write_xlsx(x = verde, path = here(dir_data_out2, "verde.xlsx"))
```

### Patrimonio museale e culturale
```{r}
#| label: patr_cult_data

patr_cult_df
tabyl(patr_cult_df$indicatore)

patr_cult <- patr_cult_df |>
  dplyr::filter(indicatore%in% c("Densità e rilevanza del patrimonio museale",
                                 "Diffusione delle aziende agrituristiche")) |>
  dplyr::filter(anno > 2012) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  dplyr::mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia"))) |> 
  # rewrite indicator names
  dplyr::mutate(
    indicatore = dplyr::case_when(
      indicatore == "Densità e rilevanza del patrimonio museale" ~ "Numero di strutture espositive permanenti per 100 km2",
      indicatore == "Diffusione delle aziende agrituristiche" ~ "Numero di aziende agrituristiche per 100 km2",
      TRUE ~ indicatore
    )
  )
```

```{r}
#| label: patr_cult_plot
#| output: true

# Plot: faceted histogram ----

patr_cult_plot <- patr_cult  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  #geom_col(position = "dodge", width = 0.8) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "grey",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)
  ) +
    facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Patrimonio museale e culturale",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

patr_cult_plot
```


\newpage

# ____

# AMBITO INTERVENTO: Valorizzare l'innovazione 

### Propensione alla brevettazione

```{r}
#| label: brev_data

# Propensione alla brevettazione

brev_data <- ric_innov_df |>
  dplyr::filter(indicatore%in% c("Propensione alla brevettazione" )) |> 
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna" , "Italia")) |>
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia")))
```

```{r}
#| label: brev_plot
#| output: true

# Plot: histogram ----
brev_plot <- brev_data  |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore, fill = territorio)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "white",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = burg_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg,
      "Nord-est" = grey_md1)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Propensione alla brevettazione",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "N. di domande di brevetto per milione di abitanti")

brev_plot
```


```{r}
#| label: brev_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  brev_data, file = here(dir_data_out2, "brev.rds"))
# as xlsx
writexl::write_xlsx(x = brev_data, path = here(dir_data_out2, "brev.xlsx"))

```



# ____

# Possibili sezioni da sviluppare 

## Terzo settore

CAPITALE SOCIALE: Tessuto sociale vitale con un terzo settore numeroso e ben rappresentato

## IA e automazione 

## Geolocalizzazione della fragilità 

[Se servono si potrebbero ricostruire mappe con indicatori di fragilità socio-economica a livello comunale per Parma e provincia]

