---
title: "Input per bilancio di missione"
author: Fondazione Cariparma - Osservatorio dei dati sociali
date: last-modified
date-format: "DD-MMMM-YYYY"
lang: it

format:
  html:
    theme: flatly #spacelab
    # css: utils/style.css
    code-fold: true # redundant bc echo false 
    toc-depth: 3
    toc_float: true
    toc-location: left
    toc-title: Indice
    embed-resources: true # external dependencies embedded (Not in ..._files/)
  docx:
    toc: false
    toc-depth: 3
    toc-title: "Indice"
    highlight-style: tango #github
    embed-resources: true
    page-width: 9
    fig-width: 8  # per usare tutta la larghezza della pagina!!!
    fig-height: 6
    dpi: 300
execute:
  eval: true
  echo: false # x mostrare codice anche in file docx
  warning: false
  error: false
  output: false

bibliography: CRP_bil_miss.bib
suppress-bibliography: false
---


```{r}
# Packgs and functions ----
library(here)
library(fs)
library(readxl)
library(janitor)
library(skimr)
library(glue)

library(dplyr)
library(tidyr)
library(forcats)
library(stringr)
library(purrr)
library(flextable)
library(sf)
library(ggplot2)
library(ggiraph)
library(camcorder)
library(patchwork) # for combining ggplots
# p1 + p2                    # Affiancati
# p1 / p2                    # Uno sopra l'altro
# p1 | p2                    # Affiancati (equivalente a +)
# (p1 + p2) / p3             # Layout complesso
# p1 + p2 + plot_layout(ncol = 2)  # Specificare colonne

# Colors ----
grey_extra_sc <- "#4F4F4F"
grey_sc <- "#808080"
grey_md1 <- "#A9A9A9"
grey_md2 <- "#D3D3D3"
grey_extrlight <- "#FDFBF7"
burg_sc <- "#5C2129"
burg_md <- "#873C4A"
burg_lg <- "#B85E6A"
blu_sc <- "#033c55"
blu_md <- "#005d82"
blu_lg <- "#5582a7"
grn_sc <- "#246864"
grn_md <- "#539d90"
grn_lg <- "#8eb9b1"
ylw_sc <- "#b27d2c"
ylw_md <- "#d9a44a"
ylw_lg <- "#f0c166"

maschi <- "#6B8FAD"
femmine <- "#C47A87"                                                           
```


```{r}
# ------- R utilities and functions  
#source(file = here("R","f_recap_values.R")) # # f_recap_values(df, c("col1","col2"))
#source(file = here("R","f_ggplot2.R")) # custom ggplot2 theme
source(file = here("R","f_ft_formatting.R")) # %>% f_ft_properties()
```

# Importazione dati

+ **Shapefile x mappe**  
[@istatConfiniUnitaAmministrative2025a]
```{r}
#| label: import_shapefiles

# Import comuni PARMA shapefile (istat, 2025) - Parma ----
ER_PR_comuni_sf <- readRDS(here("data_in", "ER_shp", "ER_PR_comuni_sf.rds")) |> 
  select(PRO_COM_T, COMUNE, Shape_Leng, Shape_Area, geometry)
# Importa tabella LINK x assegnare COMUNI A DISTRETTI ----
comuni_distretti_parma <- read_excel(here("data_in", "ER_shp", "comuni_distretti_parma.xlsx"))

```

+ **Dati popolazione residente 2025**  
I dati sulla popolazione residente vengono da 2 fonti: Istat [[@istatDemoDemografiaCifre2025]] e RE-R Statistica [@re-rstatisticaPopolazioneResidenteSesso2024].

```{r}
#| label: import_pop_resid_2025

# Import dati popolazione residente x sesso/eta in province RER ----
# ----- Puliti in `data_in/RER_statistica/convert_RER_2tidy.R` (A)
resident_prov_eta5_sex <- readRDS(here("data_in", "pop_resid_2025", "RER_statistica", "resident_prov_eta5_sex.rds")) |>
  rename(territorio = provincia) |> 
  mutate(genere =  factor(genere, levels = c("Maschi", "Femmine", "Totale")))

# Import dati stranieri PR ----
# Puliti in `data_in/istat_demo_stran_2025/convert_istat_pop_2tidy.R` (B)
resid_stran_eta5_sex_PR <- readRDS(here("data_in", "pop_resid_2025", "istat_demo_stran_2025", "resid_stran_eta5_sex_PR.rds")) |>
  mutate(genere =  factor(genere, levels = c("Maschi", "Femmine", "Totale")))

# Import dati stranieri ER ----
# Puliti in `data_in/istat_demo_stran_2025/convert_istat_pop_2tidy.R` (B)
resid_stran_eta5_sex_ER <- readRDS("~/Github/bilancio_missione/data_in/pop_resid_2025/istat_demo_stran_2025/resid_stran_eta5_sex_ER.rds")

# Import dati pop residente x sesso/eta in distretti ER ----
resident_distr_eta_sex <- readRDS(here("data_in", "pop_resid_2025", "RER_statistica", "resident_distr_eta_sex.rds")) 
```

+ **Dati TREND demografici ISTAT 2002-2024**  
[@istatDemoDemografiaCifre2025]

```{r}
#| label: import_istat_trend_demo

# --- Load dataset ISTAT TREND DEMOGRAFICI ----
indicatori_di_struttura <- readRDS(here("data_in", "istat_demo_2002_2024", "indicatori_di_struttura.rds"))
#speranza_di_vita_65 <- readRDS(here("data_in", "istat_demo_2002_2024", "speranza_di_vita_65.rds"))
crescita_naturale <- readRDS(here("data_in", "istat_demo_2002_2024", "crescita_naturale.rds"))
saldo_migratorio <- readRDS(here("data_in", "istat_demo_2002_2024", "saldo_migratorio_totale.rds"))

# Esplora indicatori disponibili
# tabyl(indicatori_di_struttura$indicatore)
```

+ **Dati fragilità demografica RE-R Statistica**  
[@re-rstatisticaPotenzialeFragilitaDemografica2025]
```{r}
#| label: fonti_bil_miss

# Import dati fragilità demografica ----
# % Popolazione residente di 65 anni e oltre in famiglie unipersonali al 31.12.2023
fragil_raw <- read_excel("data_in/fragil/Dati-Fragilita-2023-Indicatori-elementari-comunali-e-provinciali.xlsx", skip= 1)
```


+ **Dati ISTAT BES (Benessere Equo e Sostenibile)**  
[@istatBesTerritoriEmilia2025a]

<!-- 
## Dati di input (ISTAT BES)
+ Ultimo Report regionali BesT  https://www.istat.it/wp-content/uploads/2025/12/BesT2025_Emilia-Romagna.pdf
+ Riscaricato in formato molto piu facile da gestire read_excel("data_in/bes_2003_2023/Indicatori_per_provincia_sesso_ed.2025.xlsx" )
-->

```{r}
# Directories ----
bes_data_in <- here::here("data_in", "bes_2003_2023")
bes_data_out <- here::here("data_out","bes_2003_2023")
# Import full BES dataset per provincia e sesso ----
all_bes <- read_excel(here("data_in", "bes_2003_2023", "Indicatori_per_provincia_sesso_ed.2025.xlsx") , sheet = "Indicatori_per_provincia_sesso") |>
  janitor::clean_names()
```


# 1° PRIORITÀ: Ridurre le disuguaglianze 

> "La Fondazione si pone l'obiettivo strategico di affrontare dinamiche che influenzano le disparità e le distanze tra persone." [DPP 2025]"

Quali sono le **dinamiche demografiche in atto** che influenzano le disuguaglianze e le distanze tra persone?

## Popolazione residente

<!-- Dati provenienti da:
+ Istat, popolazione straniera (aggiornati al 01/01/2025), e da 
+ Regione Emilia-Romagna - Statistica, aggiornati al 03/06/2025.  
-->

```{r}
#| label: pop_prov_data

# tabyl(resident_prov_eta5_sex$genere)
# tabyl(resident_prov_eta5_sex$fascia_eta)

# popolazione residente Parma 2025
pop_parma_2025 <- resident_prov_eta5_sex |>
  dplyr::filter(territorio == "Parma" & genere == "Totale" & fascia_eta == "Tutte_eta") |>
  dplyr::pull(residenti)

# popolazione residente ER 2025
pop_ER_2025 <- resident_prov_eta5_sex |>
  dplyr::filter(territorio == "Emilia-Romagna" & genere == "Totale" & fascia_eta == "Tutte_eta") |>
  dplyr::pull(residenti)
```


```{r}
#| label: resid_stran_parma

# tabyl(resid_stran_eta5_sex_PR$genere)
# tabyl(resid_stran_eta5_sex_PR$fascia_eta)

# popolazione straniera residente Parma 2025
pop_stran_parma_2025 <- resid_stran_eta5_sex_PR |>
  dplyr::filter(territorio == "Parma" & genere == "Totale" ) |>
  # non c'è la fascia "Tutte_eta" perciò sommo tutte le età
  dplyr::summarise(
    totale_residenti_stranieri = sum(residenti)
  ) |> 
  dplyr::pull(totale_residenti_stranieri)
```

```{r}
#| label: resid_stran_ER

# tabyl(resid_stran_eta5_sex_ER$genere)
# tabyl(resid_stran_eta5_sex_ER$fascia_eta)

# popolazione straniera residente Parma 2025
pop_stran_ER_2025 <- resid_stran_eta5_sex_ER |>
  dplyr::filter(territorio == "Emilia-Romagna" & genere == "Totale" ) |>
  dplyr::summarise(
    totale_residenti_stranieri = sum(residenti)
  ) |> 
  dplyr::pull(totale_residenti_stranieri)
```

La popolazione residente nella provincia di Parma nel 2025 (ultimo aggiornamento: 03/06/2025) è di `r scales::label_number(big.mark = ".", decimal.mark = ",")(pop_parma_2025)` abitanti. Il territorio accoglie una percentuale di residenti stranieri più alta della media regionale, al cui interno, la distribuzione per età mostra una concentrazione in fasce più giovani.

### [Tbl] Popolazione residente (con % straniera)

```{r}
#| label: tbl_pop_parma_ER_2025
#| output: true

# Tabella popolazione residente Parma ed ER 2025 ( con distinzione straniera )----
tbl_pop_parma_ER_2025 <- tibble(
  Territorio = c("Parma", "Emilia-Romagna"),
  pop_residente_2025 = c(pop_parma_2025, pop_ER_2025),
  pop_stran_residente_2025 = c(pop_stran_parma_2025, pop_stran_ER_2025)) |>
  mutate(Perc_stranieri = round(pop_stran_residente_2025 /pop_residente_2025  * 100, 2)) |>
  flextable()  |>
  colformat_double(
    j = c("pop_residente_2025", "pop_stran_residente_2025"),
    big.mark = ".",
    decimal.mark = ",",
    digits = 0,
    na_str = "N.D.") |>
  # Formattazione percentuale
  colformat_double(
    j = "Perc_stranieri",
    big.mark = ".",
    decimal.mark = ",",
    digits = 2,
    suffix = " %",
    na_str = "N.D.") |>
  # Headers
  set_header_labels(
    Territorio = "Territorio",
    pop_residente_2025 = "Popolazione residente (2025)",
    pop_stran_residente_2025 = "Popolazione straniera residente (2025)",
    Perc_stranieri = "% popolazione straniera sul totale (2025)"
  ) |>
  add_header_lines(values = "Popolazione residente e straniera a Parma ed Emilia-Romagna (2025)", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Regione Emilia-Romagna - Statistica e Istat - Demografia in cifre, 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") |>
  # add background to italia and Parma
  bg(i = ~ Territorio %in% c("Parma"), bg = ylw_lg, part = "body") |>
  f_ft_word()

tbl_pop_parma_ER_2025
```


```{r}
# save as Rds
saveRDS(object =  tbl_pop_parma_ER_2025, file = here("data_out", "pop_resid_2025", "tbl_pop_parma_ER_2025.rds"))

# save as word docx
flextable::save_as_docx(tbl_pop_parma_ER_2025, path = here("data_out", "pop_resid_2025", "tbl_pop_parma_ER_2025.docx"))
```


### Piramide d'età
```{r}
#| label: plot_parma_piramid
#| output: false

# Data 
piramid_pop_PR_data <- resident_prov_eta5_sex |>
  # filter
  dplyr::filter(territorio == "Parma" & fascia_eta != "Tutte_eta" & genere %in% c("Maschi", "Femmine")) |> 
  dplyr::mutate(
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d)$", "0\\1-0\\2"),
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d{2})$", "0\\1-\\2")
  )

# ------- Save data  objects
# as RDS
saveRDS(object =  piramid_pop_PR_data, file = here("data_out", "pop_resid_2025","piramid_pop_PR_data.rds"))
# as XLSX
writexl::write_xlsx(x = piramid_pop_PR_data, path = here("data_out", "pop_resid_2025", "piramid_pop_PR_data.xlsx"))


# Plot piramide età Parma 2025 ----

# Calculate nice limit automatically
max_pop <- max(abs(piramid_pop_PR_data$residenti))
nice_limit <- ceiling(max_pop / 1000) * 1000  # Round up to nearest 1000

piramid_pop_PR <- piramid_pop_PR_data |>
  ggplot(aes(
    x = fascia_eta,
    y = residenti,
    fill = genere
  )) +
  geom_bar(
    data = \(df) df |> filter(genere == "Maschi"),
    aes(y = -residenti),
    stat = "identity"
  ) +
  geom_bar(
    data = \(df) df |> filter(genere == "Femmine"),
    aes(y = residenti),
    stat = "identity"
  ) +
  coord_flip() +
  scale_y_continuous(
    labels = \(x) scales::label_number(big.mark = ".", decimal.mark = ",")(abs(x)),
    breaks = seq(-nice_limit, nice_limit, by = nice_limit/4),
    limits = c(-nice_limit, nice_limit),
    expand = expansion(mult = 0.025)
  ) +
  scale_fill_manual(
    values = c("Maschi" = maschi, "Femmine" = femmine)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = rel(0.85), angle= 45),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    plot.subtitle = element_text(size = rel(0.95), lineheight = 1.2, margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    # title = "Popolazione residente a Parma (2025)",
    # subtitle = "Valori assoluti per sesso fasce d'età quinquennali",
    # caption = "Fonte: Regione Emilia-Romagna - Statistica",
    x = "",
    y = "",
    fill = "Sesso"
  )

# Stampa il grafico e salva manualmente
piramid_pop_PR
```

```{r}
#| label: plot_parma_str_piramid
#| output: false

# Plot piramide età stranieri Parma 2025 ----

piramid_pop_stran_PR_data <- resid_stran_eta5_sex_PR |>
  dplyr::filter(territorio == "Parma" & genere %in% c("Maschi", "Femmine")) |>
  dplyr::mutate(
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d)$", "0\\1-0\\2"),
    fascia_eta = stringr::str_replace(fascia_eta, "^(\\d)-(\\d{2})$", "0\\1-\\2")
  )

# ------- Save data and plot objects
# as RDS
saveRDS(object =  piramid_pop_stran_PR_data, file = here("data_out", "pop_resid_2025","piramid_pop_stran_PR_data.rds"))
# as XLSX
writexl::write_xlsx(x = piramid_pop_stran_PR_data, path = here("data_out", "pop_resid_2025", "piramid_pop_stran_PR_data.xlsx"))


# Calculate nice limit automatically
max_stran <- max(abs(piramid_pop_stran_PR_data$residenti))
nice_limit_stran <- ceiling(max_stran / 100) * 100  # Round up to nearest 100

piramid_pop_stran_PR <- piramid_pop_stran_PR_data  |>
  ggplot(aes(
    x = fascia_eta,
    y = residenti,
    fill = genere
  )) +
  geom_bar(
    data = \(df) df |> filter(genere == "Maschi"),
    aes(y = -residenti),
    stat = "identity"
  ) +
  geom_bar(
    data = \(df) df |> filter(genere == "Femmine"),
    aes(y = residenti),
    stat = "identity"
  ) +
  coord_flip() +
  scale_y_continuous(
    labels = \(x) scales::label_number(big.mark = ".", decimal.mark = ",")(abs(x)),
    breaks = seq(-nice_limit_stran, nice_limit_stran, by = nice_limit_stran/4),
    limits = c(-nice_limit_stran, nice_limit_stran),
    expand = expansion(mult = 0.025)
  ) +
  scale_fill_manual(
    values = c("Maschi" = maschi, "Femmine" = femmine)
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = rel(0.85), angle= 45),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    plot.subtitle = element_text(size = rel(0.95), lineheight = 1.2, margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    # title = "Popolazione STRANIERA residente a Parma (2025)",
    # subtitle = "Valori assoluti per sesso fasce d'età quinquennali",
    # caption = "Fonte: IStat, Demografia in cifre",
    x = "",
    y = "",
    fill = "Sesso"
  )


# Stampa il grafico e salva manualmente
piramid_pop_stran_PR

```

```{r}
#| output: true

library(patchwork)
# Combine plots
piramids_PR_both <- piramid_pop_PR + piramid_pop_stran_PR +
  plot_layout(guides = "collect") +  # This collects and merges legends
  plot_annotation(
    title = "Piramidi d'età della popolazione residente a Parma (2025)",
    subtitle = "Confronto tra popolazione totale e straniera (scale diverse)",
    caption = "Fonte: Regione Emilia-Romagna - Statistica e Istat - Demografia in cifre") &
  theme(
    plot.title = element_text(size = rel(1.4), face = "bold"),
    plot.subtitle = element_text(size = rel(1.1)),
    plot.caption = element_text(size = rel(0.9), face = "italic", color = grey_sc),
    legend.position = "bottom")

piramids_PR_both

# Save combined plot (manually)

```

## Popolazione per 4 distretti

La popolazione residente nella provincia di Parma è suddivisa in 4 distretti sanitari, e si concentra principalmente nel distretto di Parma città, che include il capoluogo e i comuni limitrofi.  

```{r}
#| label: map_distretti_prep

# # 1) Importa tabella link distretti-comuni
# comuni_distretti_parma <- read_excel(here("data_in", "ER_shp", "comuni_distretti_parma.xlsx"))
# 
# # 2) Import comuni PARMA shapefile (istat, 2025) - Parma ----
# ER_PR_comuni_sf <- readRDS(here("data_in", "ER_shp", "ER_PR_comuni_sf.rds")) |> 
#   select(PRO_COM_T, COMUNE, Shape_Leng, Shape_Area, geometry)

# 3) Associa distretto a ogni comune di  Parma ----
ER_PR_comuni_distr_sf <- ER_PR_comuni_sf |>
  left_join(comuni_distretti_parma, by = c("COMUNE" = "Comune")) |>
  select(PRO_COM_T, COMUNE, Distretto, Shape_Leng, Shape_Area, geometry)

skim(ER_PR_comuni_distr_sf)
str(ER_PR_comuni_distr_sf)
unique(ER_PR_comuni_distr_sf$Distretto)

# 4) Make sf union per distretto ----
ER_PR_distretti_sf <- ER_PR_comuni_distr_sf %>%
  group_by(Distretto) %>%
  summarise(
    n_comuni = n(),
    comuni = paste(COMUNE, collapse = ", "),
    geometry = st_union(geometry),
    .groups = "drop"
  ) 
```


```{r}
#| label: resid_distretti_parma_data

resident_distr_eta_sex <- resident_distr_eta_sex |> 
  # Separa una colonna con la provincia 
  dplyr::rename(distretto_prov = provincia) |> 
  dplyr::mutate(
    distretto = str_remove(distretto_prov, "\\s*\\(AUSL.*\\)$") |> str_trim(),
    ausl = str_extract(distretto_prov, "(?<=\\().*(?=\\))"),
    prov = str_extract(distretto_prov, "(?<=AUSL\\s)[A-Z]+")) |> 
  dplyr::mutate (
    provincia = case_when(
      prov == "PR" ~ "Parma",
      prov == "RE" ~ "Reggio nell'Emilia",
      prov == "MO" ~ "Modena",
      prov == "PC" ~ "Piacenza",
      prov == "BO" ~ "Bologna",
      prov == "I" ~ "Bologna",
      prov == "FE" ~ "Ferrara",
      prov == "R" & str_detect(distretto_prov, "Forlì") ~ "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Cesena")~  "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Rubicone")~  "Forlì-Cesena",
      prov == "R" & str_detect(distretto_prov, "Rimini")~  "Rimini",
      prov == "R" & str_detect(distretto_prov, "Riccione")~  "Rimini",
      
      prov == "R" & str_detect(distretto_prov, "Ravenna")~  "Ravenna",
      prov == "R" & str_detect(distretto_prov, "Faenza")~  "Ravenna",
      prov == "R" & str_detect(distretto_prov, "Lugo")~  "Ravenna",
      TRUE ~ NA_character_)) |>  
  # filtra dati popolazione per distretti Parma ----
dplyr::filter(prov == "PR")

names(resident_distr_eta_sex)
names(ER_PR_distretti_sf)
tabyl(resident_distr_eta_sex$fascia_eta)
tabyl(resident_distr_eta_sex$distretto)
tabyl(resident_distr_eta_sex$distretto_prov)

# Aggiungi geometria manualmente ----
resident_distr_eta_sex_sf <- resident_distr_eta_sex |>
  left_join(
    ER_PR_distretti_sf |> st_drop_geometry(),
    by = c("distretto_prov" = "Distretto")) |>
  left_join(
    ER_PR_distretti_sf |> select(Distretto, geometry),
    by = c("distretto_prov" = "Distretto")) |>
  st_as_sf()

# # 2) Split into separate datasets per sesso / eta ----
# distr_eta_tutti <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "Tutte_eta" & genere == "Totale") 
# 
# distr_eta_0_13 <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "0-13" & genere == "Totale")
# 
# distr_eta_14_59 <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "14-59" & genere == "Totale")
# 
# distr_eta_60_plus <- resident_distr_eta_sex |>
#   dplyr::filter(fascia_eta == "60  e oltre" & genere == "Totale")
# 
# # 3) Associa geometria distretti a dati popolazione per distretti Parma ----
# distr_eta_tutti_sf <- ER_PR_distretti_sf |>
#   full_join(
#     distr_eta_tutti,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# distr_eta_0_13_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_0_13,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# 
# distr_eta_14_59_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_14_59,
#     by = c("Distretto" = "distretto_prov")
#   )
# 
# distr_eta_60_plus_sf <- ER_PR_distretti_sf |>
#   left_join(
#     distr_eta_60_plus,
#     by = c("Distretto" = "distretto_prov")
#   )

# Save joined data 
saveRDS(object =  resident_distr_eta_sex_sf, file = here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf.rds"))
# as XLSX
writexl::write_xlsx(x = resident_distr_eta_sex_sf, path = here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf.xlsx"))
# as shapefile
fs::dir_create(here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf_shp"))

sf::write_sf( resident_distr_eta_sex_sf,  here("data_out", "pop_resid_2025", "resident_distr_eta_sex_sf_shp",  "resident_distr_eta_sex_sf.shp"))
```

### [Tbl] Popolazione residente per distretti di Parma

```{r}
#| label: tbl_pop_distr_2025
#| output: true

# Tabella popolazione residente Parma ed ER 2025 ( con distinzione straniera )----
tbl_pop_distr_2025 <- resident_distr_eta_sex |>
  dplyr::filter(fascia_eta == "Tutte_eta" & genere == "Totale") |> 
  select(provincia, distretto_prov, residenti) |> 
  flextable()  |>
  # Headers
  set_header_labels( 
    provincia = "Provincia",
    distretto_prov = "Distretto",
    residenti = "Popolazione residente"
  ) |>
  add_header_lines(values = "Popolazione residente per distretto sanitario (2025)", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Regione Emilia-Romagna - Statistica, 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") 

tbl_pop_distr_2025

# save as Rds
saveRDS(object =  tbl_pop_distr_2025, file = here("data_out", "pop_resid_2025", "tbl_pop_distr_2025.rds"))
# save as word docx
flextable::save_as_docx(tbl_pop_distr_2025, path = here("data_out", "pop_resid_2025", "tbl_pop_distr_2025.docx"))
```

### Mappa popolazione residente per distretto

I distretti _Sud Est_ e _Valli Taro e Ceno_ sono i meno popolati e presentano il potenziale maggiore di fragilità sociale, oltre che demografica (percentuale di residenti anziani e soli, difficoltà di radicamento della popolazione straniera, opportunità di istruzione) -- Cfr. **RE-R Statistica**, 2025, [_"La potenziale fragilità demografica, sociale ed economica nei comuni della regione Emilia Romagna. Anno 2023"_](https://statistica.regione.emilia-romagna.it/studi-analisi/pubblicazioni-ricerche/rapporto-mappe-potenziale-fragilita-emilia-romagna-2023). 

```{r}
#| label: map_distretti_parma_pop
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"

# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "Tutte_eta") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = str_wrap(distretto, width = 20)), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis", begin = 0.5, end = 0.9,
    direction = -1,
    na.value = "grey90",
    name = "N. residenti",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = "") +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop
```

```{r}
#| label: map_distretti_parma_pop_anz
#| output: false
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"


# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_anz <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "60  e oltre") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = str_wrap(distretto, width= 20)), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "rocket",
    direction = -1,
    na.value = "grey90",
    name = "N. residenti 60+",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (60 anni e oltre)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_anz
```

```{r}
#| label: map_distretti_parma_pop_anz_per
#| output: false
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"

# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_anz_per <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta %in% c("60  e oltre", "Tutte_eta")) |>
  group_by(distretto) |> 
  summarise(total_residenti = sum(if_else(fascia_eta == "Tutte_eta", residenti, 0)),
            residenti_60_plus = sum(if_else(fascia_eta == "60  e oltre", residenti, 0)),
            perc_60_plus = residenti_60_plus / total_residenti * 100,
            .groups = "drop"
  ) |>
  ggplot() +
  geom_sf(aes(fill = perc_60_plus), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = str_wrap(distretto, width= 20)), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis", begin = 0.5, end = 0.9,
    direction = -1,
    na.value = "grey90",
    name = "% residenti >60",
    breaks = seq(0, 40, by = 5),
    labels = scales::label_number(suffix = "%", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (60 anni e oltre in %)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_anz_per
```

```{r}
#| label: map_distretti_parma_pop_gio
#| output: false
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"


# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_gio <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta == "0-13") |>
  ggplot() +
  geom_sf(aes(fill = residenti), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = str_wrap(distretto, width= 20)), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis", begin = 0.5, end = 0.9,
    direction = -1,
    na.value = "grey90",
    name = "N. residenti < 14",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (0-13 anni)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_gio
```

```{r}
#| label: map_distretti_parma_pop_gio_per
#| output: false
#| fig-cap: ""
#| out-width: 100%

# Arguments
fonte_anno_agg <- "Istat/SITUAS (2025)"
fonte_nome <- "Confini dei Comuni"

fonte2_anno_agg <- "RE-R Statistica (2025)"
fonte2_nome <- "Popolazione residente"

# Plot mappa distretti Parma con popolazione residente 2025 ----
map_distretti_parma_pop_gio_per <- resident_distr_eta_sex_sf |> 
  filter(genere == "Totale" & fascia_eta %in% c("0-13", "Tutte_eta")) |>
  group_by(distretto) |> 
  summarise(total_residenti = sum(if_else(fascia_eta == "Tutte_eta", residenti, 0)),
            residenti_0_13 = sum(if_else(fascia_eta == "0-13", residenti, 0)),
            perc_0_13 = residenti_0_13 / total_residenti * 100,
            .groups = "drop"
  ) |>
  ggplot() +
  geom_sf(aes(fill = perc_0_13), color = "white", linewidth = rel(0.2)) +
  geom_sf_label(aes(label = str_wrap(distretto, width= 20)), size = 3, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis", begin = 0.5, end = 0.9,
    direction = -1,
    na.value = "grey90",
    name = "% residenti <14",
    breaks = seq(0, 20, by = 2),
    labels = scales::label_number(suffix = "%", decimal.mark = ",")
  ) +
  labs(
    title    = "Popolazione residente per distretto sanitario (0-13 anni in %)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption  = glue::glue("Fonte: {fonte_anno_agg} — {fonte_nome}; \n{fonte2_anno_agg} — {fonte2_nome}"),
    x = "",    y = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

map_distretti_parma_pop_gio_per
```

### Mappa popolazione per distetto e fasce d'età (%)
```{r}
#| label: map_distretti_parma_pop_anz_gio_per_patch
#| output: true

# Combine plots
# Combine plots - remove titles/subtitles/captions from individual plots
map_distretti_parma_pop_anz_gio_per_patch <-
  (map_distretti_parma_pop_anz_per + labs(title = NULL, subtitle = NULL, caption = NULL)) +
  (map_distretti_parma_pop_gio_per + labs(title = NULL, subtitle = NULL, caption = NULL)) +
  plot_annotation(
    title = "Popolazione residente per distretto sanitario: età 0-13 e 60+ (in %)",
    subtitle = "(Confini = unione di comuni di pertinenza)",
    caption = "Fonte: Istat/SITUAS (2025) — Confini dei Comuni; RE-R Statistica (2025) — Popolazione residente"
  ) &
  theme(
    plot.title = element_text(size = rel(1.4), face = "bold"),
    plot.subtitle = element_text(size = rel(1.1)),
    plot.caption = element_text(size = rel(0.9), face = "italic", color = grey_sc),
    legend.position = "bottom"
  )

map_distretti_parma_pop_anz_gio_per_patch

# Save combined plot (manually)
```

### Mappa over 65 soli per comune

Uno degli indicatori "spia" di potenziale fragilità sociale è la `percentuale di popolazione residente di 65+ anni in familglie unipersonali` (**RE-R Statistica, 2025**, con dati al 31.12.2023).

```{r}
# # % Popolazione residente di 65 anni e oltre in famiglie unipersonali al 31.12.2023
# 
# fragil_raw <- read_excel("data_in/fragil/Dati-Fragilita-2023-Indicatori-elementari-comunali-e-provinciali.xlsx", skip= 1)

names(fragil_raw)

over65_unip <-  fragil_raw |> 
  filter (den_prov == "Parma" ) |> 
  select(cod_com, den_com, socind1)

# Join over65_unip with ER_PR_comuni_sf ----
over65_unip_sf <- ER_PR_comuni_sf |>
  left_join(
    over65_unip,
    by = c("PRO_COM_T" = "cod_com")
  ) |> 
  st_as_sf()

# Save joined data
saveRDS(object =  over65_unip_sf, file = here("data_out", "fragil", "over65_unip_sf.rds"))
# as XLSX
writexl::write_xlsx(x = over65_unip_sf |> st_drop_geometry(), path = here("data_out", "fragil", "over65_unip_sf.xlsx"))
# as shapefile
fs::dir_create(here("data_out", "fragil", "over65_unip_sf_shp"))
sf::write_sf( over65_unip_sf,  here("data_out", "fragil", "over65_unip_sf_shp",  "over65_unip_sf.shp"))
```

```{r}
#| label: over65_unip_map
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Plot mappa over65 unipersonali Parma 2023 ----
over65_unip_map <- over65_unip_sf |> 
  ggplot() +
  geom_sf(aes(fill = socind1), color = "white", linewidth = rel(0.2)) +
  #geom_sf_label(aes(label = den_com), size = 2, alpha = 0.7) +  # Etichette con sfondo
  scale_fill_viridis_c(
    option = "cividis", begin = 0.5, end = 0.9,
    direction = -1,
    na.value = "grey90",
    name = "%. residenti soli 65+",
    labels = scales::label_number(big.mark = ".", decimal.mark = ",")
  ) +
  # Add layer for distretti borders
  geom_sf(data = ER_PR_distretti_sf, fill = NA, color = blu_sc, linewidth = rel(0.5)) +
  # ADd labs
  labs(
    title    = "Popolazione residente di 65 anni e oltre in famiglie unipersonali  (Anno 2023)",
    subtitle = "Indicatore in % per comune",
    caption  = str_wrap("Fonte: Regione Emilia-Romagna - La potenziale fragilità demografica, sociale ed economica nei comuni della regione Emilia-Romagna (2023)", width = 80),
    x = "",    y = "") +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10),
    # Rimuove assi coordinati e griglia per mappa più pulita
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

over65_unip_map

# Save plot (manually)
```

## Trend demografici a confronto
<!-- ## Dati di input (ISTAT trend dem) -->

In generale, l’analisi degli indicatori demografici 2002-2025 come il profilo demografico di Parma si distingue per certi indicatori sia dalla media regionale che nazionale. In particolare, si evidenzia un trend di invecchiamento più contenuto e una dinamica migratoria più vivace che contribuisce a bilanciare il deficit di natalità generalizzato.

### Età media

Aumento della popolazione anziana e longevità

```{r}
#| label: e_m_data

# ------- Arguments for plot
INDICATORE <- "Età media"
UDM <- "anni e decimi di anno"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
e_m_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)

# ------- Save data and plot objects
# as RDS
saveRDS(object =  e_m_data, file = here("data_out", "istat_demo_2002_2024", "e_m_data.rds"))
# as XLSX
writexl::write_xlsx(x = e_m_data, path = here("data_out", "istat_demo_2002_2024", "e_m_data.xlsx"))
# as PNG (manuale)
```


```{r}
#| label: e_m_plot
#| output: true

# Plot: e_m_plot [= Età Media]  ----
e_m_plot <- e_m_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(e_m_data$anno), max(e_m_data$anno), by = 1),
    limits = c(min(e_m_data$anno), max(e_m_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
e_m_plot
```

### Indice di vecchiaia

```{r}
#| label: i_v_data

# ------- Arguments for plot
INDICATORE <- "Indice di vecchiaia"
UDM <- "% tra popolazione di 65+ anni e in età 0-14"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_v_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_v_data, file = here("data_out", "istat_demo_2002_2024", "i_v_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_v_data, path = here("data_out", "istat_demo_2002_2024", "i_v_data.xlsx"))
```

```{r}
#| label: i_v_plot
#| output: true

# Plot: i_v_plot [= Età Media]  ----
i_v_plot <- i_v_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_v_data$anno), max(i_v_data$anno), by = 1),
    limits = c(min(i_v_data$anno), max(i_v_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_v_plot
```

### Indice di dipendenza anziani

```{r}
#| label: i_d_a_data

# ------- Arguments for plot
INDICATORE <- "Indice di dipendenza anziani"
UDM <- "% tra popolazione di 65+ e in età attiva (15-64 anni)"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_d_a_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_d_a_data, file = here("data_out", "istat_demo_2002_2024", "i_d_a_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_d_a_data, path = here("data_out", "istat_demo_2002_2024", "i_d_a_data.xlsx"))
```

```{r}
#| label: i_d_a_plot
#| output: true

# Plot: i_d_a_plot [= Età Media]  ----
i_d_a_plot <- i_d_a_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_d_a_data$anno), max(i_d_a_data$anno), by = 1),
    limits = c(min(i_d_a_data$anno), max(i_d_a_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_d_a_plot
```


### Indice di dipendenza strutturale

```{r}
#| label: i_d_s_data

# ------- Arguments for plot
INDICATORE <- "Indice di dipendenza strutturale"
UDM <- "% tra popolazione in età non attiva (0-14 e 65+ anni) e in età attiva (15-64 anni)"
TITLE <- glue("Trend demografici: {INDICATORE}")
SUBTIT <- glue("Indicatore espresso in: {UDM}")
CAP <- "Fonte: Istat, Demografia in cifre, Nov. 2025"

# ------- Read input data
i_d_s_data <- indicatori_di_struttura |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  ) |>
  dplyr::mutate(
    highlight = territorio %in%
      c("Parma", "Emilia-Romagna", "ITALIA"),
    territorio_display = ifelse(highlight, territorio, "Altro")
  ) |>
  #maintain
  dplyr::mutate(
    territorio_display = factor(
      territorio_display,
      levels = c("Parma", "Emilia-Romagna", "ITALIA", "Altro")
    ),
    highlight = factor(highlight)
  ) |> 
  dplyr::filter(indicatore == INDICATORE)


# ------- Save data and plot objects
# as RDS
saveRDS(object =  i_d_s_data, file = here("data_out", "istat_demo_2002_2024", "i_d_s_data.rds"))
# as XLSX
writexl::write_xlsx(x = i_d_s_data, path = here("data_out", "istat_demo_2002_2024", "i_d_s_data.xlsx"))
```

```{r}
#| label: i_d_s_plot
#| output: true

# Plot: i_d_s_plot [= Età Media]  ----
i_d_s_plot <- i_d_s_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio_display,
    group = territorio)) +
  # Linee normali
  geom_line(linewidth = rel(1.2)) +
  # Linea più spessa per Parma ed Emilia-Romagna
  geom_line(
    data = \(df) df |> filter(territorio %in% c("Parma", "Emilia-Romagna")),
    linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(i_d_s_data$anno), max(i_d_s_data$anno), by = 1),
    limits = c(min(i_d_s_data$anno), max(i_d_s_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = TITLE,
    subtitle = SUBTIT,
    caption = CAP,
    x = "",
    y = "")  

# Stampa il grafico (questo triggera il salvataggio)
i_d_s_plot
```

### Crescita naturale della popolazione

```{r}
#| label: c_n_data

c_n_data <- crescita_naturale |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "ITALIA")) |>
  dplyr::mutate(
    territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "ITALIA"))
  )

```

```{r}
#| label: c_n_plot
#| output: true

c_n_plot <- c_n_data |>
  dplyr::filter(indicatore == "crescita_naturale") |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio,
    group = territorio
  )) +
  geom_line(linewidth = rel(1.2)) +
  scale_x_continuous(
    breaks = seq(min(c_n_data$anno), max(c_n_data$anno), by = 1),
    limits = c(min(c_n_data$anno), max(c_n_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(
      size = rel(1.3),
      face = "bold",
      margin = margin(b = 10)
    ),
    plot.subtitle = element_text(
      size = rel(0.95),
      lineheight = 1.2,
      margin = margin(b = 10)
    ),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Trend demografici: crescita naturale",
    subtitle = "Indicatore espresso in: differenza tra il tasso di natalità e il tasso di mortalità",
    caption = CAP,
    x = "",
    y = ""
  )

c_n_plot
```

```{r}
#| label: c_n_data_save

# ------- Save data and plot objects
# as RDS
saveRDS(object =  c_n_data, file = here("data_out", "istat_demo_2002_2024", "c_n_data.rds"))
# as XLSX
writexl::write_xlsx(x = c_n_data, path = here("data_out", "istat_demo_2002_2024", "c_n_data.xlsx"))

```


### Saldo migratorio

```{r}
#| label: s_m_data

# ------- Read input data
s_m_data <- saldo_migratorio |>
  dplyr::filter(
    territorio %in%
      c(
        # "Bologna",
        # "Piacenza",
        "Parma",
        # "Reggio nell'Emilia",
        # "Modena",
        # "Ferrara",
        # "Ravenna",
        # "Forli'",
        # "Rimini",
        "Emilia-Romagna",
        # "NORD-EST",
        "ITALIA"
      )
  )  

# ------- Save data and plot objects
# as RDS
saveRDS(object =  s_m_data, file = here("data_out", "istat_demo_2002_2024", "s_m_data.rds"))
# as XLSX
writexl::write_xlsx(x = s_m_data, path = here("data_out", "istat_demo_2002_2024", "s_m_data.xlsx"))
```

```{r}
#| label: s_m_plot
#| output: true

# Plot: i_d_s_plot [= Età Media]  ----
s_m_plot <- s_m_data |>
  ggplot(aes(
    x = anno,
    y = valore,
    color = territorio,
    group = territorio)) +
  geom_line(linewidth = rel(1.2) ) +
  scale_x_continuous(
    breaks = seq(min(s_m_data$anno), max(s_m_data$anno), by = 1),
    limits = c(min(s_m_data$anno), max(s_m_data$anno)),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_md,
      "Emilia-Romagna" = grn_md,
      "ITALIA" = blu_md)  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(
      size = rel(1.3),
      face = "bold",
      margin = margin(b = 10) ),
    plot.subtitle = element_text(
      size = rel(0.95),
      lineheight = 1.2,
      margin = margin(b = 10)  ),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")  ) +
  labs(
    title = "Trend demografici: saldo migratorio totale",
    subtitle = "Indicatore espresso in: differenza tra num. iscritti ed num. cancellati dai registri anagrafici per trasferimento di residenza",
    caption = CAP,
    x = "",
    y = "")
# Stampa il grafico (questo triggera il salvataggio)
s_m_plot
```

<!-- ### Migrazione e diversità culturale -->

### Mobilità dei laureati


```{r}
#| label: bes_mob_lau_data

bes_mob_lau <-  all_bes |>
  filter (territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  filter(indicatore == "Mobilità dei laureati italiani (25-39 anni)")   |>
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia"))) |> 
  select(indicatore, territorio, sesso, v2019:v2023)


# save data
saveRDS(object =  bes_mob_lau, file = here(bes_data_out, "bes_mob_lau.rds"))
writexl::write_xlsx(x = bes_mob_lau, path = here(bes_data_out, "bes_mob_lau.xlsx"))
```

Parma ed Emilia-Romagna registrano saldi migratori positivi dei laureati (attrazione netta), mentre l'Italia nel complesso perde laureati verso l'estero, con tassi negativi stabilmente tra -2 e -8 per mille nel periodo 2019-2023.

```{r}
#| label: bes_mob_lau_plot
#| output: true

# Plot: histogram ----
bes_mob_lau_plot <- bes_mob_lau  |>
  filter(sesso == "Totale") |>
  # make long 
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    names_prefix = "v",
    values_to = "valore"
  ) |>
  dplyr::mutate(
    anno = as.integer(anno),
    territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")),
    valore_num = as.numeric(gsub(",", ".", valore))
  ) |>
  ggplot(aes(x = anno, y = valore_num, fill = territorio)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single", padding = 0),
           width = 0.9,
           color = "white",
           linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg )) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ",", suffix = "‰"), 
    breaks = scales::breaks_extended(n = 10),
    expand= expansion(mult = c(0.25,0.25))
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(1)),
    axis.text.y = element_text(size = rel(1)),
    axis.title = element_text(size = rel(0.9), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Mobilità (Iscritti - Cancellati) per trasferimento \ndi residenza dei laureati italiani (25-39 anni)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "Saldo su residenti X 1000")

bes_mob_lau_plot
```

::: {.callout-note}

**Mobilità dei laureati italiani (25-39 anni)** = Tasso di migratorietà specifico dei laureati italiani di 25-39 anni (differenza tra iscritti e cancellati per trasferimento di residenza/popolazione residente *1000). Sia il numeratore che il denominatore si riferiscono ai cittadini italiani di 25-39 anni con titolo di studio terziario (laurea, AFAM, dottorato). I valori per l'Italia comprendono solo i movimenti da/per l'estero, poiché il saldo migratorio interno a livello nazionale è pari a zero; la disaggregazione territoriale comprende anche i movimenti interni.
:::


\newpage

# ____

# 2° PRIORITÀ: Rafforzare istituzioni e persone 

> "La Fondazione si pone l'obiettivo strategico di lavorare per il rafforzamento di entrambe i livelli, persone e istituzioni"come crescita, formazione innovazione, e come messa in rete del proprio contributo. [DPP 2025]"


## Benessere economico delle famiglie

Da diversi anni, Istat ha sviluppato un approccio multidimensionale per misurare il **“Benessere equo e sostenibile” (Bes)**, che consente di tracciare alcune fondamentali dimensioni del benessere, ma anche potenziali fonti di disuguaglianza, osservate per diverse aggregazioni territoriali.  [[@istatBesTerritoriEmilia2025a]]

<!-- https://www.istat.it/statistiche-per-temi/focus/benessere-e-sostenibilita/la-misurazione-del-benessere-bes 
DAl 2013, 12 indicatrori sono entrati a far parte del del processo di programmazione economica-finanziaria del Paese, attraverso l'allegato del Dpfp (Documento di programmazione e di finanza pubblica). --> 


### Reddito medio (da lavoro e pensione)

Dal punto di vista del `reddito medio disponibile pro capite` (calcolato al netto di imposte e contributi), negli anni recenti Parma si è confermata al di sopra della media regionale e nazionale.  



::: {.callout-note}
Il **Reddito medio disponibile pro capite (€)** è un _aggregato di contabilità nazionale_ che rappresenta il reddito medio annuo di cui una persona può disporre, al netto di imposte e contributi, tenendo conto anche di pensioni e trasferimenti pubblici.

+ NB: anche se viene chiamato "reddito disponibile _lordo_ pro capite" nei documenti Istat, in realta' è già al netto delle imposte e dei contributi sociali obbligatori, quindi non è lordo in senso fiscale comune, ma nel senso della contabilita' nazionale.

+ In termini comparativi internazionali, il reddito disponibile pro capite è espresso in unità di potere d'acquisto (Purchasing Power Standard - PPS), che consente di eliminare le differenze di prezzo tra i paesi e di confrontare il potere d'acquisto effettivo dei redditi delle famiglie (+/- comparabile con  **Adjusted gross disposable income of households per capita in PPS** - [Eurostat](https://ec.europa.eu/eurostat/databrowser/view/tec00113/default/table?lang=en)).
:::

```{r}
#| label: redd_data

bes_reddito <- all_bes |>
  filter(dominio == "Benessere economico") |>
  filter (territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |>
  filter (unita_misura == "Euro" ) |>
  filter(sesso == "Totale") |>
  select(indicatore, territorio, v2021, v2022, v2023) |> 
  # in ordine per grafico
  mutate(
    territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia")),
    indicatore = factor(indicatore, levels = c(
      "Reddito medio disponibile pro capite",
      "Retribuzione media annua dei lavoratori dipendenti",
      "Importo medio annuo pro-capite dei redditi pensionistici"
    ))
  ) |> 
  # make col v numeric
  mutate(across(c(v2021, v2022, v2023), ~ as.numeric(str_replace(.x, ",", "."))))                

# ------- Save data 
# as RDS
saveRDS(object = bes_reddito, file = here(bes_data_out, "bes_reddito.rds"))
# as XLSX
writexl::write_xlsx(x = bes_reddito, path = here(bes_data_out, "bes_reddito.xlsx"))
```


```{r}
#| label: bes_reddito_barplot
#| output: true
#| fig-cap: ""
#| out-width: 100%

# Prepare data for plotting
bes_reddito_long <- bes_reddito |>
  tidyr::pivot_longer(
    cols = c("v2021", "v2022", "v2023"),
    names_to = "anno",
    values_to = "value",
    names_prefix = "v"  # Remove the "v" prefix
  ) 

# Create faceted barplot
reddito_barplot <- bes_reddito_long |>
  mutate(value_num = as.numeric(gsub(",", ".", value))) |>
  ggplot(aes(x = anno, y = value_num, fill = territorio)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(
    aes(label = scales::number(value_num, big.mark = ".", decimal.mark = ",", accuracy = 1)),
    position = position_dodge(width = 0.7),
    vjust = -0.5,
    size = 3
  ) +
  facet_wrap(~ indicatore, ncol = 1, scales = "fixed") +
  scale_fill_manual(
    values = c(
      "Parma" = ylw_lg,
      "Italia" = blu_lg,
      "Emilia-Romagna" = grn_lg
    )
  ) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    expand = expansion(mult = c(-.1, 0.3))
  ) +
  labs(
    title = "Indicatori economici per territorio",
    subtitle = "Confronto 2021-2023",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "Anno",
    y = "Euro (€)",
    fill = "Territorio"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = rel(1.2)),
    plot.subtitle = element_text(size = rel(1)),
    plot.caption = element_text(size = rel(0.8), face = "italic", color = grey_sc, hjust = 0),
    legend.position = "bottom",
    strip.text = element_text(face = "bold", size = rel(1), hjust = 0),
    strip.background = element_rect(fill = grey_md2, color = NA)
  )

reddito_barplot
```

### [Tbl] Reddito medio disponibile pro capite

<!-- Qs tabella è copiata a mano da [IstatData](https://esploradati.istat.it/databrowser/#/it/dw/categories/IT1,Z0930TER,1.0/BES_T/IT1,DF_BES_TERRIT_0T,1.0) -->

```{r}
#| label: bes_reddito_tbl
#| output: true

bes_reddito_tbl <- bes_reddito |>
  flextable() |>
  colformat_double(
    j = c("v2021", "v2022", "v2023"),
    big.mark = ".",
    decimal.mark = ",",
    digits = 0,
    na_str = "N.D.") |>
  set_header_labels(
    indicatore = "Indicatore",
    territorio = "Territorio",
    v2021 = "2021",
    v2022 = "2022",
    v2023 = "2023"
  ) |>
  add_header_lines(values = "Indicatori economici per territorio (€), 2021-2023", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") |>
  # Merge col with same Indicatore
  flextable::merge_v( j = "indicatore", part = "body") |> 
  
  # add background to italia and Parma
  # bg(i = ~ territorio %in% c("Italia"), bg = blu_lg, part = "body") |>
  bg(i = ~ territorio %in% c("Parma"), bg = ylw_lg, part = "body") |>
  f_ft_word()

bes_reddito_tbl
```

```{r}
# save as Rds
saveRDS(object =  bes_reddito_tbl, file = here(bes_data_out, "bes_reddito_tbl.rds"))

# save as word docx
flextable::save_as_docx(bes_reddito_tbl, path = here(bes_data_out, "bes_reddito_tbl.docx"))
```


```{r}
#| label: bes_redd_m_f_data

bes_redd_m_f <- all_bes |>
  filter(dominio == "Benessere economico" & indicatore == "Retribuzione media annua dei lavoratori dipendenti") |>
  filter (territorio %in% c("Parma",  "Italia")) |>
  filter (unita_misura == "Euro" ) |>
  filter(sesso %in% c("Maschi", "Femmine"))  |> 
  # in ordine per grafico
  mutate(
    territorio = factor(territorio, levels = c("Parma",  "Italia")),
    v2023 = as.numeric(str_replace(v2023, ",", "."))) |> 
  select(indicatore, territorio, sesso, v2023) |> 
  arrange(territorio, sesso)

# ------- Save data 
# as RDS
saveRDS(object = bes_redd_m_f, file = here(bes_data_out, "bes_redd_m_f.rds"))
# as XLSX
writexl::write_xlsx(x = bes_redd_m_f, path = here(bes_data_out, "bes_redd_m_f.xlsx"))
```

#### Maschi e Femmine 

Occorre però rilevare che, anche a Parma, come in Italia, permane un divario retributivo di genere significativo (questo è un dato complessivo, che andrebbe chiaramente approfondito).
```{r}
#| label: bes_reddito_m_f_table
#| output: true

bes_reddito_m_f_tbl <- bes_redd_m_f |>
  flextable() |>
  colformat_num(
    j = c("v2023"),
    big.mark = ".",
    decimal.mark = ",",
    digits = 0,
    na_str = "N.D.") |>
  set_header_labels(
    indicatore = "Indicatore",
    territorio = "Territorio",
    sesso = "Sesso",
    v2023 = "2023"
  ) |>
  add_header_lines(values = "Retribuzione media per sesso (€), 2023", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") |>
  # Merge col with same Indicatore
  flextable::merge_v( j = "indicatore", part = "body") |> 
  flextable::merge_v( j = "territorio", part = "body") 

bes_reddito_m_f_tbl

# save as Rds
saveRDS(object =  bes_reddito_m_f_tbl, file = here(bes_data_out, "bes_reddito_m_f_tbl.rds"))
# save as word docx
flextable::save_as_docx(bes_reddito_m_f_tbl, path = here(bes_data_out, "bes_reddito_m_f_tbl.docx"))
```


### Occupazione

Il tasso di occupazione a Parma (20-64 anni) si mantiene stabilmente intorno il 75% dal 2018, superando sia la media regionale che nazionale. Il tasso giovanile (15-29 anni) mostra un trend lievemente migliorativo ma resta inferiore al 45%.  

Anche a Parma, che supera sistematicamente l'Italia nei tassi di occupazione, si riscontra un divario marcato tra i sessi (circa 20 punti percentuali per adulti, 18 per giovani, nel 2024) che rispecchia la situazione nazionale.  
```{r}
#| label: occup_data

bes_lav <- all_bes |> 
  filter(dominio == "Lavoro e conciliazione dei tempi di vita") |>
  filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) 

tabyl(bes_lav$indicatore)

# Indicatori di occupazione
bes_occup <- bes_lav |> 
  dplyr::filter(indicatore%in% c("Tasso di occupazione (20-64 anni)",
                                 "Tasso di occupazione giovanile (15-29 anni)")) |>
  # Select only useful for plot
  select( territorio, indicatore, sesso, unita_misura, v2018, v2019, v2020, v2021, v2022, v2023, v2024)  |> 
  # transform to long format
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    values_to = "valore",
    names_prefix = "v"
  ) |>
  dplyr::mutate(anno = as.integer(anno)) |>
  dplyr::mutate(
    indicatore = factor(indicatore, levels = c(
      "Tasso di occupazione (20-64 anni)",
      "Tasso di occupazione giovanile (15-29 anni)"
    ))
  )

# save as RDS
saveRDS(object =  bes_occup, file = here(bes_data_out, "bes_occup.rds"))
# save as xlsx
writexl::write_xlsx(x = bes_occup, path = here(bes_data_out, "bes_occup.xlsx"))

```

```{r}
#| label: bes_occup_plot
#| output: true

# Plot: faceted line with points ----
bes_occup_plot <- bes_occup  |>
  dplyr::filter(sesso == "Totale") |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore_num, color = territorio, group = territorio)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    limits = c(20, 80),
    breaks = seq(20, 80, by = 10)
  ) +
  facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Tassi di occupazione",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

bes_occup_plot
```

#### Maschi e femmine (2024)

```{r}
#| label: bes_occup_mf_plot
#| output: true

# Plot: faceted dodged bars ----
bes_occup_mf_plot <- bes_occup  |>
  dplyr::filter(sesso  %in% c("Maschi", "Femmine")) |>
  dplyr::filter(territorio %in% c("Parma", "Italia")) |>
  dplyr::filter(anno == 2024) |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  mutate(sesso = factor(sesso, levels = c("Maschi", "Femmine"))) |>
  mutate(territorio = factor(territorio, levels = c("Parma", "Italia"))) |>
  tidyr::complete(anno, territorio, indicatore, sesso) |>
  ggplot(aes(x = territorio, y = valore_num, fill = sesso)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(
    values = c(
      "Maschi" = maschi,
      "Femmine" = femmine)) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)) +
  facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(1)),
    axis.text.y = element_text(size = rel(0.95)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "right",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Tassi di occupazione per genere - Anno 2024",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "")

bes_occup_mf_plot
```

### Disoccupazione e mancata partecipazione al lavoro

In base al **tasso di mancata partecipazione al lavoro**, Parma (ed Emilia-Romagna) registrano performance significamente migliori dela media nazionale, pur mantenendo lo svantaggio per la fascia più giovane, e un divario sfavorevole per le donne. 

::: {.callout-note}
Il **tasso di mancata partecipazione al lavoro** misura il _Rapporto tra la somma di disoccupati e inattivi "disponibili" (persone che non hanno cercato lavoro nelle ultime 4 settimane ma sono disponibili a lavorare), e la somma di forze lavoro (insieme di occupati e disoccupati) e inattivi "disponibili", riferito alla popolazione tra 15 e 74 anni._ Questo dato cattura le difficoltà nel coinvolgimento della popolazione nel mercato del lavoro. 
:::


```{r}
#| label: bes_disoccup_data

# Indicatori di DISoccupazione
bes_disoccup <- bes_lav |>
  dplyr::filter(indicatore%in% c("Tasso di mancata partecipazione al lavoro",
                                 "Tasso di mancata partecipazione al lavoro giovanile (15-29 anni)")) |>
  # Select only useful for plot
  select( territorio, indicatore, sesso, unita_misura, v2018, v2019, v2020, v2021, v2022, v2023, v2024)  |> 
  # transform to long format
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    values_to = "valore",
    names_prefix = "v"
  ) |>
  dplyr::mutate(anno = as.integer(anno)) |>
  # rewrite indicator names
  dplyr::mutate(
    indicatore = dplyr::case_when(
      indicatore == "Tasso di mancata partecipazione al lavoro" ~ "% di disoccupati e inattivi 'disponibili' (15-74 anni)",
      indicatore == "Tasso di mancata partecipazione al lavoro giovanile (15-29 anni)" ~ "% di disoccupati e inattivi 'disponibili' (15-29 anni)",
      TRUE ~ indicatore
    )
  ) |>
  dplyr::mutate(
    indicatore = factor(indicatore, levels = c(
      "% di disoccupati e inattivi 'disponibili' (15-74 anni)",
      "% di disoccupati e inattivi 'disponibili' (15-29 anni)"
    ))
  )
# save as RDS 
saveRDS(object =  bes_disoccup, file = here(bes_data_out, "bes_disoccup.rds"))
# save as xlsx
writexl::write_xlsx(x = bes_disoccup, path = here(bes_data_out, "bes_disoccup.xlsx"))
```


```{r}
#| label: bes_disoccup_plot
#| output: true

# Plot: faceted line with points ----
bes_disoccup_plot <- bes_disoccup |>
  dplyr::filter(sesso == "Totale") |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore_num, color = territorio, group = territorio)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2018, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    expand = expansion(mult = c(0.05, 0.1))
  ) +
  facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Mancata partecipazione al lavoro",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

bes_disoccup_plot
```

#### Maschi e femmine (al 2024)
```{r}
#| label: bes_disoccup_m_f_plot
#| output: true

# Plot: faceted dodged bars ----
bes_disoccup_mf_plot <- bes_disoccup  |>
  dplyr::filter(sesso  %in% c("Maschi", "Femmine")) |>
  mutate(sesso = factor(sesso, levels = c("Maschi", "Femmine"))) |>
  dplyr::filter(territorio %in% c("Parma", "Italia")) |>
  mutate(territorio = factor(territorio, levels = c("Parma", "Italia"))) |>
  dplyr::filter(anno == 2024) |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  ggplot(aes(x = territorio, y = valore_num, fill = sesso)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(
    values = c(
      "Maschi" = maschi,
      "Femmine" = femmine)) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    breaks = scales::breaks_pretty(n = 5),
    expand = expansion(mult = c(0, 0.1))
  ) +
  facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(1)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.2), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title =  "Mancata partecipazione al lavoro per genere - Anno 2024" ,
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

bes_disoccup_mf_plot
```

### Formazione e NEET

Parma mostra tassi NEET costantemente inferiori alla media nazionale (10,9% vs 15,2% nel 2024), abbastanza in linea con la regione. Per i laureati, Parma ha registrato un calo (da 32,4% nel 2018 a 30,8% nel 2024), posizionandosi ora sotto la media regionale (36,4%) ma in linea con quella nazionale (30,9%).  

Resta piuttosto alta la partecipazione a formazione continua sul territorio -- superata solo nel 2024 dalla media regionale.       
<!-- [Dati un po' incompleti, sarebbe bello approfondire da fonte primaria: _Rilevazione sulle Forze di lavoro_] -->
```{r}
#| label: bes_neet_data

bes_neet <- all_bes |>
  dplyr::filter(dominio == "Istruzione e formazione") |>
  dplyr::filter (territorio %in% c("Parma", "Emilia-Romagna" , "Italia" )) |> 
  mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia")))    |>
  filter(indicatore %in% c("Giovani che non lavorano e non studiano (NEET)",
                           "Laureati e altri titoli terziari (25-39 anni)"#,
                           # "Persone con almeno il diploma (25-64 anni)"
  ))  |> 
  mutate(
    indicatore = dplyr::case_when(
      indicatore == "Giovani che non lavorano e non studiano (NEET)" ~ "NEET (15-29 anni)",
      indicatore == "Laureati e altri titoli terziari (25-39 anni)" ~ "Laureati e altri titoli terziari (25-39 anni)",
      TRUE ~ indicatore
    )
  ) |>
  dplyr::mutate(
    indicatore = factor(indicatore, levels = c(
      "NEET (15-29 anni)",
      "Laureati e altri titoli terziari (25-39 anni)"#,
      # "Persone con almeno il diploma (25-64 anni)"
    ))
  ) |>
  # Select only useful for plot
  select( indicatore, territorio, sesso, unita_misura, v2018, v2019, v2020, v2021, v2022, v2023, v2024) 

# save as RDS
saveRDS(object =  bes_neet, file = here(bes_data_out, "bes_neet.rds"))
# save as xlsx
writexl::write_xlsx(x = bes_neet, path = here(bes_data_out, "bes_neet.xlsx"))
```

```{r}
#| label: bes_neet_plot
#| output: true

# Plot: line with dots  ----
bes_neet_plot <- bes_neet  |>
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    values_to = "valore",
    names_prefix = "v") |>
  mutate(anno = as.integer(anno)) |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore_num, color = territorio, group = territorio)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    limits = c(NA, NA),
    breaks = scales::breaks_pretty(n = 5),
    expand = expansion(mult = c(0.2, 0.2))
  ) +
  facet_wrap(~ indicatore, ncol = 1) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Giovani che non lavorano e non studiano (NEET) \ne Formazione superiore",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

bes_neet_plot
```


```{r}
#| label: bes_formaz_data

bes_formaz <-  all_bes |>
  dplyr::filter(dominio == "Istruzione e formazione") |>
  dplyr::filter (territorio %in% c("Parma", "Emilia-Romagna" , "Italia" )) |> 
  mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia")))    |>
  filter(indicatore %in% c("Partecipazione alla formazione continua" ))  |> 
  # Select only useful for plot
  select( indicatore, territorio, sesso, unita_misura, v2018, v2019, v2020, v2021, v2022, v2023, v2024) 

# save as RDS
saveRDS(object =   bes_formaz, file = here(bes_data_out, "bes_formaz.rds"))
# save as xlsx
writexl::write_xlsx(x = bes_formaz, path = here(bes_data_out, "bes_formaz.xlsx"))
```

```{r}
#| label: bes_formaz_plot
#| output: true

# Plot:  like bes_neet_plot  ----
bes_formaz_plot <- bes_formaz  |>
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    values_to = "valore",
    names_prefix = "v"
  ) |>
  mutate(anno = as.integer(anno)) |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  ggplot(aes(x = anno, y = valore_num, color = territorio, group = territorio)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg
    )
  ) +
  scale_x_continuous(
    breaks = seq(2018, 2024, by = 1),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = scales::label_percent(scale = 1, decimal.mark = ","),
    breaks = scales::breaks_pretty(n = 5),
    expand = expansion(mult = c(0.05, 0.1))
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom"
  ) +
  labs(
    title = "Partecipazione alla formazione continua (25-64 anni)",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = ""
  )

bes_formaz_plot
```

# ____

# 3° PRIORITÀ: Accompagnare le trasformazioni del territorio

> "La Fondazione si pone l'obiettivo strategico di accompagnare il territorio di parma lungo le trasformazioni e i cambiamenti inevitabili", supportando una nuova visione strategiica e valorizzando sinergia tra obiettivi. [DPP 2025]"

<!-- ### Servizi sanitari -->
```{r}
#| label: bes_serv_san_data

# NON uso xche incompleti e fuori scopo 
bes_serv_san <- all_bes |>
  dplyr::filter(indicatore%in% c("Emigrazione ospedaliera in altra regione",
                                 "Medici specialisti",
                                 "Posti letto per specialità ad elevata assistenza")) |>
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) 

bes_serv_san |> 
  flextable()
```

## Qualità dei servizi e ambiente

[QUI HO MESSO SOLO LE TABELLE PERCHE' SONO DATI UN PO' DISPARATI: SI POTREBBE FARSI AIUTARE E FARE DELLE INFOGRAFICHE UN PO' PIÙ INTERESSANTI...]{style="color: red;"}    


```{r}
#| label: bes_servizi_data

bes_servizi <-  all_bes |>
  dplyr::filter(dominio%in% c("Qualità dei servizi", "Ambiente", 
                              "Paesaggio e patrimonio culturale",
                              "Innovazione, ricerca e creatività")) |> 
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna", "Italia")) |> 
  mutate(territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna", "Italia"))) |>
  select(-codice, -sesso,-dominio, -nota, -(starts_with("w"))) |> 
  filter(indicatore %in% c(
    # Qualità dei servizi ---
    "Copertura della rete fissa di accesso ultra veloce a internet",
    "Comuni con servizi per le famiglie interamente online",
    "Raccolta differenziata dei rifiuti urbani",
    "Irregolarità del servizio elettrico",
    "Posti-km offerti dal Tpl",
    "Disponibilità di verde urbano",
    "Densità e rilevanza del patrimonio museale",
    # Inquinamento --- 
    "Rifiuti urbani prodotti",
    "Dispersione da rete idrica comunale",
    "Impermeabilizzazione del suolo da copertura artificiale",
    "Concentrazione media annua di PM10",
    "Concentrazione media annua di PM2.5",
    "Energia elettrica da fonti rinnovabili")) |> 
  
  mutate( indicatore = factor(indicatore, levels = c(
    # Qualità dei servizi ---
    "Copertura della rete fissa di accesso ultra veloce a internet",
    "Comuni con servizi per le famiglie interamente online",
    "Raccolta differenziata dei rifiuti urbani",
    "Irregolarità del servizio elettrico",
    "Posti-km offerti dal Tpl",
    "Disponibilità di verde urbano",
    "Densità e rilevanza del patrimonio museale",
    # Inquinamento --- 
    "Rifiuti urbani prodotti",
    "Dispersione da rete idrica comunale",
    "Impermeabilizzazione del suolo da copertura artificiale",
    "Concentrazione media annua di PM10",
    "Concentrazione media annua di PM2.5",
    "Energia elettrica da fonti rinnovabili")))  |> 
  # in columns starting with v, and where unita_misura is "Valori percentuali" & not NA , add the % sign to the values
  mutate(across(starts_with("v"), ~ ifelse(
    unita_misura == "Valori percentuali" & !is.na(.), paste0(., "%"), .)))

tabyl(bes_servizi$indicatore)
```

### [Tbl] Servizi sul territorio 

Nella qualità dei servizi sul territorio, si evidenziano performance migliori a Parma rispetto alla media regionale per quasi tutti gli indicatori considerati, in particolare nella **disponibilità di verde urbano**. Sui **posti-km offerti dal trasporto pubblico locale**, Parma è al di sopra della regione, ma resta al di sotto della media nazionale.

```{r}
#| label: bes_servizi_tbl
#| output: true

bes_servizi_tbl <- bes_servizi |>
  select(-fonte, -(v2004:v2017), -v2024) |>
  filter(indicatore %in%  c(
    # Qualità dei servizi ---
    "Copertura della rete fissa di accesso ultra veloce a internet",
    "Comuni con servizi per le famiglie interamente online",
    "Raccolta differenziata dei rifiuti urbani",
    "Irregolarità del servizio elettrico",
    "Posti-km offerti dal Tpl",
    "Disponibilità di verde urbano",
    "Densità e rilevanza del patrimonio museale")) |> 
  relocate (unita_misura, .after = indicatore) |>
  arrange( indicatore, territorio) |>
  flextable() |> 
  flextable::merge_v( j = "indicatore", target = c("indicatore", "unita_misura"), part = "body") |> 
  bg (i = ~ territorio == "Parma", j = 3:9, bg = ylw_lg )  |> 
  # ALign years column to the right
  flextable::align(j = c("v2018", "v2019", "v2020", "v2021", "v2022", "v2023"), align = "right", part = "body") |>
  # Headers
  set_header_labels(  
    unita_misura = "unità di misura",
    v2018 = "2018",
    v2019 = "2019",
    v2020 = "2020",
    v2021 = "2021",
    v2022 = "2022",
    v2023 = "2023"
  ) |>
  add_header_lines(values = "Qualità dei servizi (confronto territori) ", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") 

bes_servizi_tbl

# save as RDS
saveRDS(object =  bes_servizi, file = here("data_out","bes_2003_2023", "bes_servizi_tbl.rds"))
# save as docx
flextable::save_as_docx(bes_servizi_tbl, path = here("data_out","bes_2003_2023", "bes_servizi_tbl.docx"))
```

### [Tbl] Ambiente 

Nell'ambito ambientale, si evidenzia una certa disomogeneità tra Parma e l'Emilia-Romagna -- come nella **dispersione idrica** in cui la media regionale sembra molto più virtuosa, o nella **concentrazione di polveri sottili** (pur molto al di sotto della media nazionale). Parma mostra performance migliori della media regionale per quel che concerne l'**impermeabilizzazione del suolo** e la **produzione di rifiuti urbani**. 

```{r}
#| label: bes_ambiente_tbl
#| output: true

bes_ambiente_tbl <- bes_servizi |>
  select(-fonte, -(v2004:v2017), -v2024) |>
  filter(indicatore %in%  c(
    "Rifiuti urbani prodotti",
    # Inquinamento --- 
    "Dispersione da rete idrica comunale",
    "Impermeabilizzazione del suolo da copertura artificiale",
    "Concentrazione media annua di PM10",
    "Concentrazione media annua di PM2.5",
    "Energia elettrica da fonti rinnovabili" ))|> 
  relocate (unita_misura, .after = indicatore) |>
  arrange( indicatore, territorio) |> 
  flextable() |> 
  flextable::merge_v( j = "indicatore", target = c("indicatore", "unita_misura"), part = "body") |> 
  bg (i = ~ territorio == "Parma", j = 3:9, bg = ylw_lg )  |> 
  # ALign years column to the right
  flextable::align(j = c("v2018", "v2019", "v2020", "v2021", "v2022", "v2023"), align = "right", part = "body") |>
  # Headers
  set_header_labels(  
    unita_misura = "unità di misura",
    v2018 = "2018",
    v2019 = "2019",
    v2020 = "2020",
    v2021 = "2021",
    v2022 = "2022",
    v2023 = "2023"
  ) |>
  add_header_lines(values = "Qualità dei servizi (confronto territori) ", top = TRUE) |>
  bold(part = "header", i = 1) |>
  fontsize(size = 14, part = "header", i = 1) |>
  align(align = "center", part = "header", i = 1) |>
  add_footer_lines("Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025") |>
  fontsize(size = 9, part = "footer") |>
  italic(part = "footer") |>
  color(color = grey_sc, part = "footer") 

bes_ambiente_tbl

# save as RDS
saveRDS(object =  bes_servizi, file = here("data_out","bes_2003_2023", "bes_ambiente_tbl.rds"))
# save as docx
flextable::save_as_docx(bes_ambiente_tbl, path = here("data_out","bes_2003_2023", "bes_ambiente_tbl.docx"))
```

\newpage

# ____

# AMBITO INTERVENTO: Valorizzare l'innovazione 

<!-- + REGIONI RIS https://emiliaromagnainnodata.art-er.it/indicatori-r-e-i/ -->
<!-- + PARMA E ER https://digitale.regione.emilia-romagna.it/notizie/2025/maggio/a-spasso-con-desier-le-performance-di-innovazione-digitale-del-comune-di-parma -->
<!--   + https://docs.google.com/spreadsheets/d/1G1F2ByRsXnmN0nXHHF9wgL-LHzVhtuvcKYzC8tJI19Q/edit?gid=0#gid=0 -->
<!-- + https://ireser.it/wp-content/uploads/2025/11/OSS_PR_2025_DEF2.pdf -->


### Propensione alla brevettazione

Secondo dati dell’Ufficio Europeo Brevetti ( _European Patent Office_, o EPO), al 2024, l'Italia è il 6° paese dell'EU per brevetti presentati (4,853 su 68,392) e l'11° nel ranking globale, principalmente nei comparti: **Trasporti**, seguito da **Handling** e **Altre macchine speciali**. [@eurostatPatentApplicationsEPO2024]

Tra le regioni italiane, Lombardia, Emilia-Romagna e Veneto restano quelle più attive, contribuendo a oltre il 60% delle domande totali dall’Italia. La Lombardia si conferma
leader per numero assoluto di brevetti presentate (1.468 domande, 30,2% del totale nazionale), pur con un calo del 9,7%, seguita dall’Emilia-Romagna (922, pari al 19,0% del totale italiano), che evidenzia una contrazione più contenuta (-3,8%). Se però prendiamo in
considerazione il numero di brevetti in rapporto alla popolazione residente, l’Emilia-Romagna si conferma anche nel 2024 come prima regione in Italia per domande di brevetto depositate
pro-capite, con 207 domande. [@art-erBrevettiDellEuropeanPatent2025]



[GRAFICO COPIATO: SI PUÒ RIFARE SE LO TENIAMO...]{style="color: red;"}   


::: {layout-ncol=2}

![1)](data_in/eurostat_brevetti/brevetti.png)
![2)](data_in/eurostat_brevetti/brevetti_pop.png)

:::


```{r}
#| label: bes_brev
#| eval: false

# Propensione alla brevettazione

bes_brev <- all_bes |>
  dplyr::filter(dominio %in% c("Innovazione, ricerca e creatività")) |>
  dplyr::filter(indicatore %in% c("Propensione alla brevettazione" 
  )) |> 
  dplyr::filter(territorio %in% c("Parma", "Emilia-Romagna" , "Italia")) |>
  dplyr::mutate (territorio = factor(territorio, levels = c("Parma", "Emilia-Romagna" , "Italia")))
```

```{r}
#| label: bes_brev_plot
#| eval: false
#| output: false

# Plot: histogram ----
bes_brev_plot <- bes_brev  |>
  select(-fonte, -(v2004:v2017), -v2023, -v2024, -unita_misura) |>
  tidyr::pivot_longer(
    cols = starts_with("v"),
    names_to = "anno",
    values_to = "valore",
    names_prefix = "v") |>
  mutate(anno = as.integer(anno)) |>
  mutate(valore_num = as.numeric(gsub(",", ".", valore))) |>
  tidyr::complete(anno, territorio, indicatore) |>
  ggplot(aes(x = anno, y = valore_num, color = territorio)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "Parma" = ylw_lg,
      "Emilia-Romagna" = grn_lg,
      "Italia" = blu_lg,
      "Nord-est" = grey_md1)) +
  scale_x_continuous(
    breaks = seq(2004, 2025, by = 1),
    expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(
    labels = scales::label_number(big.mark = ".", decimal.mark = ","),
    breaks = scales::breaks_extended(n = 10)) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = rel(0.3)),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 1, size = rel(0.85)),
    axis.text.y = element_text(size = rel(0.85)),
    axis.title = element_text(size = rel(1), face = "bold"),
    plot.title = element_text(size = rel(1.3), face = "bold", margin = margin(b = 10)),
    strip.text = element_text(size = rel(1.1), face = "bold"),
    legend.text = element_text(size = rel(0.9)),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines")) +
  labs(
    title = "Propensione alla brevettazione",
    subtitle = "Confronto territoriale",
    caption = "Fonte: Istat, BES (Benessere Equo e Sostenibile), 2025",
    x = "",
    y = "N. di domande di brevetto per milione di abitanti")

bes_brev_plot
```


### Indicatori DESIER di innovazione digitale

<!-- https://digitale.regione.emilia-romagna.it/notizie/2025/maggio/a-spasso-con-desier-le-performance-di-innovazione-digitale-del-comune-di-parma -->

L'**indice DESIER** (_Digital Economy and Society Index for European Regions_) misura le performance digitali delle regioni europee, e consente di declinare l'indice DESI sull’innovazione digitale anche nei territori dell’Emilia-Romagna [@re-ragendadigitaledellemilia-romagnaSpassoConDESIER2025]. Questo strumento (realizzato realizzato nell’ambito delle attività di ADER, Agenda Digitale dell’Emilia-Romagna) consente l'analisi di 4 dimensioni di sviluppo principali che, a loro volta, combinano molti indicatori:

+ `Capitale Umano` - aspetti connessi alle competenze digitali, la presenza di specialisti del settore digitale, la presenza
e l’utilizzo di app, di alcuni servizi online, e social della Pubblica Amministrazione.
+ `Connettività` - grado di copertura Internet con rete fissa e mobile e il relativo grado di utilizzo nel territorio.
+ `Integrazione delle tecnologie digitali` - presenza sul territorio di imprese del mondo ICT, imprese innovative, start-up e finanziamenti provenienti dalla Smart Specialisation Strategy Regionale, con particolare riferimento alla digitalizzazione
del mondo produttivo.
+ `Servizi pubblici digitali` - vari aspetti connessi all’esistenza di open data e la possibilità di interagire online con la PA locale, o al grado di utilizzo delle Piattaforme abilitanti da parte dei cittadini e delle imprese (es. SPID, e servizi della sanità digitale online).

Questi indici mostrano una situazione abbastanza disomogenea tra Parma capoluogo (che si attesta tra i territori più avanzati della regione) e la provincia di Parma (che si posiziona in linea o al di sotto della media regionale).

[GRAFICO COPIATO: SI PUÒ RIFARE SE LO TENIAMO...]{style="color: red;"}   

![](data_in/desier/desier_parma_PR_ER.png)


# Fonti

